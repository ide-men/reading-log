<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>èª­æ›¸ãƒ­ã‚°</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a0a0f;
      --bg-surface: #12121a;
      --bg-elevated: #1a1a25;
      --accent: #e8a87c;
      --accent-glow: rgba(232, 168, 124, 0.25);
      --accent-soft: rgba(232, 168, 124, 0.1);
      --text-bright: #f5f5f7;
      --text-normal: #c9c9d0;
      --text-muted: #6b6b7a;
      --text-dim: #45454f;
      --border: rgba(255, 255, 255, 0.06);
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg-deep); color: var(--text-normal); line-height: 1.6; }
    .app { height: 100%; display: flex; flex-direction: column; max-width: 430px; margin: 0 auto; position: relative; }

```
/* Tabs */
.tab { display: none; flex-direction: column; height: 100%; padding-bottom: 72px; }
.tab.active { display: flex; }

/* Nav */
.nav { position: absolute; bottom: 0; left: 0; right: 0; display: flex; background: var(--bg-surface); border-top: 1px solid var(--border); padding: 8px 0; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background: none; border: none; cursor: pointer; }
.nav-item span:first-child { font-size: 22px; }
.nav-item span:last-child { font-size: 10px; color: var(--text-muted); }
.nav-item.active span:last-child { color: var(--accent); font-weight: 500; }

/* Header */
.header { padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
.header-title { font-family: 'Noto Sans JP', sans-serif; font-size: 18px; font-weight: 700; color: var(--text-bright); }
.header-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 10px; font-size: 16px; cursor: pointer; }
.header-btn.primary { background: var(--accent); border: none; color: var(--bg-deep); font-size: 22px; font-weight: 300; }

/* Main */
.main { flex: 1; overflow-y: auto; padding: 0 20px 20px; }
.main::-webkit-scrollbar { display: none; }

/* Progress */
.progress { display: flex; flex-direction: column; align-items: center; padding: 16px 0; }
.progress-ring { width: 150px; height: 150px; transform: rotate(-90deg); }
.progress-ring circle { fill: none; stroke-width: 7; }
.progress-ring .bg { stroke: var(--bg-elevated); }
.progress-ring .fill { stroke: var(--accent); stroke-linecap: round; stroke-dasharray: 414.69; stroke-dashoffset: 414.69; transition: stroke-dashoffset 0.5s; filter: drop-shadow(0 0 8px var(--accent-glow)); }
.progress-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
.progress-level { font-family: 'DM Sans', sans-serif; font-size: 34px; font-weight: 700; color: var(--text-bright); letter-spacing: -0.02em; }
.progress-title { font-size: 12px; color: var(--accent); margin-top: 2px; }
.progress-xp { font-size: 12px; color: var(--text-muted); margin-top: 10px; }
.progress-xp span { color: var(--accent); font-family: 'DM Sans', sans-serif; font-weight: 700; }
.progress-wrapper { position: relative; }

/* Stats */
.stats { display: flex; justify-content: center; gap: 28px; margin-bottom: 16px; }
.stat { text-align: center; }
.stat-value { font-family: 'DM Sans', sans-serif; font-size: 22px; font-weight: 700; color: var(--text-bright); letter-spacing: -0.02em; }
.stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px; }

/* Action Button */
.action-btn { width: 100%; padding: 16px; font-size: 16px; font-weight: 700; font-family: inherit; border: none; border-radius: var(--radius-lg); cursor: pointer; transition: transform 0.2s; }
.action-btn.start { background: linear-gradient(135deg, var(--accent), #d4956a); color: var(--bg-deep); box-shadow: 0 0 40px var(--accent-glow); }
.action-btn.stop { background: var(--bg-elevated); color: var(--text-bright); border: 1px solid var(--border); }
.action-btn:active { transform: scale(0.98); }

/* Quote */
.quote { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 16px; margin-top: 14px; }
.quote-text { font-size: 13px; font-style: italic; color: var(--text-normal); line-height: 1.7; }
.quote-author { font-size: 11px; color: var(--text-muted); margin-top: 6px; text-align: right; }

/* Books Tab */
.bookshelf { padding: 20px 0; margin: 0 -20px 20px; background: linear-gradient(to bottom, #1a1410, #12121a 70%); position: relative; overflow: hidden; }
.bookshelf::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h60v60H0z' fill='none'/%3E%3Cpath d='M30 30m-1 0a1 1 0 1 0 2 0a1 1 0 1 0-2 0' fill='%23ffffff08'/%3E%3C/svg%3E"); opacity: 0.5; pointer-events: none; }
.bookshelf-header { text-align: center; padding: 8px 20px 16px; position: relative; z-index: 1; }
.bookshelf-title { font-size: 12px; color: var(--accent); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 4px; }
.bookshelf-count { font-family: 'DM Sans', sans-serif; font-size: 36px; font-weight: 700; color: var(--text-bright); letter-spacing: -0.02em; }
.bookshelf-label { font-size: 13px; color: var(--text-muted); }
.bookshelf-scroll { overflow-x: auto; overflow-y: visible; padding: 60px 20px 12px; scrollbar-width: none; -ms-overflow-style: none; position: relative; z-index: 1; }
.bookshelf-scroll::-webkit-scrollbar { display: none; }
.bookshelf-cabinet { display: inline-block; background: linear-gradient(to right, #2a1f1a, #3d2e24, #2a1f1a); border-radius: 8px; padding: 8px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.3); }
.bookshelf-row { display: flex; align-items: flex-end; gap: 2px; padding: 6px 10px 0; position: relative; min-height: 56px; }
.bookshelf-row::after { content: ''; position: absolute; bottom: 0; left: 4px; right: 4px; height: 6px; background: linear-gradient(to bottom, #5d4037, #4e342e, #3e2723); border-radius: 1px; box-shadow: 0 2px 3px rgba(0,0,0,0.4); }
.bookshelf-book { width: 12px; border-radius: 1px 2px 0 0; position: relative; z-index: 1; box-shadow: 1px 0 2px rgba(0,0,0,0.3); flex-shrink: 0; transition: transform 0.2s, margin 0.2s; cursor: pointer; }
.bookshelf-book:hover { transform: translateY(-4px) scale(1.05); z-index: 10; margin: 0 2px; }
.bookshelf-book::before { content: ''; position: absolute; left: 1px; right: 1px; top: 4px; height: 1px; background: rgba(255,255,255,0.2); }
.bookshelf-book::after { content: ''; position: absolute; left: 1px; right: 2px; top: 8px; bottom: 8px; background: rgba(0,0,0,0.15); }
.book-tooltip { position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--bg-surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 12px; color: var(--text-bright); white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 100; text-align: center; line-height: 1.5; }
.book-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--bg-surface); }
.bookshelf-book:hover .book-tooltip { opacity: 1; visibility: visible; pointer-events: auto; }
.tooltip-link { display: block; margin-top: 6px; padding: 4px 10px; background: var(--accent); color: var(--bg-deep); border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: 500; }
.tooltip-link:hover { opacity: 0.9; }
.bookshelf-hint { text-align: center; font-size: 11px; color: var(--text-dim); padding-top: 8px; position: relative; z-index: 1; }
.bookshelf-empty { text-align: center; padding: 32px 20px; color: var(--text-muted); font-size: 14px; }

.book-item { display: flex; align-items: center; gap: 14px; padding: 14px 0; border-bottom: 1px solid var(--border); }
.book-item:last-child { border-bottom: none; }
.book-cover { width: 40px; height: 54px; background: var(--bg-elevated); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
.book-info { flex: 1; min-width: 0; }
.book-title { font-size: 14px; color: var(--text-bright); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.book-title a { color: inherit; text-decoration: none; }
.book-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.book-xp { background: var(--accent-soft); color: var(--accent); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px; }
.book-edit { background: none; border: none; color: var(--text-muted); font-size: 14px; padding: 8px; cursor: pointer; }
.book-delete { background: none; border: none; color: var(--text-dim); font-size: 18px; padding: 8px; cursor: pointer; }

.empty { text-align: center; padding: 40px; color: var(--text-muted); }
.empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }

/* Stats Tab */
.impact { background: linear-gradient(135deg, var(--accent), #d4956a); border-radius: var(--radius-lg); padding: 28px; text-align: center; color: var(--bg-deep); margin-bottom: 20px; }
.impact-value { font-family: 'DM Sans', sans-serif; font-size: 40px; font-weight: 700; letter-spacing: -0.02em; }
.impact-label { font-size: 14px; opacity: 0.8; }
.impact-sub { font-size: 13px; opacity: 0.9; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1); }

.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
.stats-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; text-align: center; }
.stats-card-value { font-family: 'DM Sans', sans-serif; font-size: 24px; font-weight: 700; color: var(--text-bright); letter-spacing: -0.02em; }
.stats-card-label { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

.section-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; }

.week-chart { display: flex; align-items: flex-end; gap: 4px; height: 120px; padding: 12px 8px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 20px; overflow: hidden; }
.week-bar { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; min-width: 0; }
.week-bar-fill { width: 100%; max-width: 28px; background: linear-gradient(to top, var(--accent), #f0c27b); border-radius: 4px 4px 0 0; min-height: 4px; }
.week-bar-fill.empty { background: var(--bg-elevated); }
.week-bar-fill.today { box-shadow: 0 0 8px var(--accent-glow); }
.week-bar-label { font-size: 10px; color: var(--text-muted); margin-top: 6px; flex-shrink: 0; }
.week-bar-label.today { color: var(--accent); font-weight: 500; }

.style-card { display: flex; align-items: center; gap: 14px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 16px; margin-bottom: 10px; }
.style-icon { font-size: 24px; }
.style-value { font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 700; color: var(--text-bright); }
.style-label { font-size: 11px; color: var(--text-muted); }

.tip { display: flex; align-items: center; gap: 10px; background: var(--accent-soft); border-radius: var(--radius-md); padding: 14px 16px; margin-top: 20px; }
.tip-icon { font-size: 18px; }
.tip-text { font-size: 13px; color: var(--text-normal); }

/* Reading Screen */
.reading { position: fixed; inset: 0; background: var(--bg-deep); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
.reading.active { display: flex; }
.flame { width: 140px; height: 140px; margin-bottom: 40px; position: relative; display: flex; align-items: flex-end; justify-content: center; }
.flame-glow { position: absolute; bottom: 10%; width: 100px; height: 100px; background: radial-gradient(circle, var(--accent-glow), transparent 70%); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
.flame-shape { position: absolute; bottom: 20%; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; animation: flicker 0.4s ease-in-out infinite alternate; }
.flame-outer { width: 44px; height: 60px; background: linear-gradient(to top, var(--accent), #f0c27b, #fff5e6); left: 50%; transform: translateX(-50%); }
.flame-inner { width: 24px; height: 40px; background: linear-gradient(to top, #fff5e6, #fff); left: 50%; transform: translateX(-50%); bottom: 25%; }
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.15); opacity: 0.6; } }
@keyframes flicker { 0% { transform: translateX(-50%) scaleY(1) scaleX(1); } 100% { transform: translateX(-50%) scaleY(1.06) scaleX(0.94); } }
.reading-label { font-size: 15px; color: var(--text-muted); margin-bottom: 48px; }
.reading-stop { padding: 14px 40px; font-size: 14px; font-family: inherit; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text-bright); cursor: pointer; }

/* Modal */
.modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: flex-end; justify-content: center; z-index: 200; }
.modal-bg.active { display: flex; }
.modal { background: var(--bg-surface); border-radius: var(--radius-lg) var(--radius-lg) 0 0; width: 100%; max-width: 430px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-bar { width: 36px; height: 4px; background: var(--text-dim); border-radius: 2px; margin: 12px auto; }
.modal-header { padding: 8px 20px 16px; display: flex; justify-content: space-between; align-items: center; }
.modal-title { font-family: 'Noto Sans JP', sans-serif; font-size: 18px; font-weight: 700; color: var(--text-bright); }
.modal-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--bg-elevated); border: none; border-radius: 8px; color: var(--text-muted); font-size: 18px; cursor: pointer; }
.modal-body { padding: 0 20px 28px; }

/* Form */
.form-group { margin-bottom: 16px; }
.form-label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
.form-input { width: 100%; padding: 14px; font-size: 16px; font-family: inherit; background: var(--bg-deep); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-bright); }
.form-input:focus { outline: none; border-color: var(--accent); }

.celebration { text-align: center; padding: 16px 0 20px; }
.celebration-icon { font-size: 40px; }
.celebration-text { font-size: 14px; color: var(--text-muted); margin-top: 8px; }

.btn { width: 100%; padding: 16px; font-size: 15px; font-weight: 700; font-family: inherit; border: none; border-radius: var(--radius-md); cursor: pointer; }
.btn-primary { background: linear-gradient(135deg, var(--accent), #d4956a); color: var(--bg-deep); display: flex; align-items: center; justify-content: center; gap: 10px; }
.btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-muted); margin-top: 10px; }
.btn-danger { background: rgba(248,113,113,0.1); border: 1px solid rgba(248,113,113,0.3); color: #f87171; }
.btn-badge { background: rgba(0,0,0,0.15); padding: 3px 8px; border-radius: 4px; font-size: 12px; }

.link-toggle { display: flex; align-items: center; gap: 6px; background: none; border: none; color: var(--text-muted); font-size: 12px; font-family: inherit; cursor: pointer; padding: 6px 0; }
.link-toggle span:first-child { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; background: var(--bg-elevated); border-radius: 4px; font-size: 12px; }
.link-fields { margin-top: 10px; display: none; }
.link-fields.open { display: block; }

.input-with-btn { display: flex; gap: 8px; }
.input-with-btn .form-input { flex: 1; }
.paste-btn { padding: 0 14px; font-size: 18px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; }

/* Overlays */
.overlay { position: fixed; inset: 0; background: rgba(10,10,15,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 300; }
.overlay.active { display: flex; }
.overlay-content { text-align: center; animation: popIn 0.5s ease; }
@keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.overlay-icon { font-size: 64px; margin-bottom: 20px; }
.overlay-label { font-size: 13px; color: var(--accent); letter-spacing: 0.15em; margin-bottom: 8px; }
.overlay-value { font-family: 'DM Sans', sans-serif; font-size: 42px; font-weight: 700; color: var(--text-bright); letter-spacing: -0.02em; }
.overlay-sub { font-size: 14px; color: var(--text-muted); margin-top: 4px; }
.overlay-btn { margin-top: 40px; padding: 12px 28px; font-size: 13px; font-family: inherit; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-bright); cursor: pointer; }

.confirm { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 400; }
.confirm.active { display: flex; }
.confirm-box { background: var(--bg-surface); border-radius: var(--radius-md); padding: 32px; margin: 20px; max-width: 340px; width: 100%; text-align: center; }
.confirm-icon { font-size: 42px; margin-bottom: 16px; }
.confirm-title { font-size: 18px; font-weight: 700; color: var(--text-bright); margin-bottom: 10px; }
.confirm-text { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; line-height: 1.5; }
.confirm-btns { display: flex; gap: 12px; }
.confirm-btns button { flex: 1; padding: 14px; font-size: 15px; font-family: inherit; border-radius: var(--radius-sm); cursor: pointer; }
.confirm-cancel { background: var(--bg-deep); border: 1px solid var(--border); color: var(--text-bright); }
.confirm-ok { background: #dc2626; border: none; color: white; font-weight: 700; }

.toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px 20px; font-size: 13px; color: var(--text-bright); z-index: 250; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; }
@keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
@keyframes toastOut { to { opacity: 0; } }

.confetti { position: fixed; inset: 0; pointer-events: none; z-index: 500; overflow: hidden; }
.confetti i { position: absolute; width: 8px; height: 8px; animation: fall 3s ease-out forwards; }
@keyframes fall { 0% { transform: translateY(-50px) rotate(0); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

.milestone { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: var(--bg-surface); border: 2px solid var(--accent); border-radius: var(--radius-md); padding: 28px; text-align: center; z-index: 350; box-shadow: 0 0 40px var(--accent-glow); animation: popIn 0.4s ease; }
.milestone-icon { font-size: 40px; margin-bottom: 12px; }
.milestone-title { font-family: 'Noto Sans JP', sans-serif; font-size: 18px; font-weight: 700; color: var(--text-bright); margin-bottom: 6px; }
.milestone-text { font-size: 13px; color: var(--text-muted); }

.settings-hint { font-size: 11px; color: var(--text-dim); margin-top: 8px; text-align: center; }
```

  </style>
</head>
<body>
  <div class="app">
    <!-- Home Tab -->
    <div class="tab active" id="tab-home">
      <header class="header">
        <h1 class="header-title">ğŸ“– Reading Log</h1>
        <button class="header-btn" onclick="openSettings()">âš™ï¸</button>
      </header>
      <main class="main">
        <section class="progress">
          <div class="progress-wrapper">
            <svg class="progress-ring" viewBox="0 0 150 150">
              <circle class="bg" cx="75" cy="75" r="66"/>
              <circle class="fill" id="ring" cx="75" cy="75" r="66"/>
            </svg>
            <div class="progress-center">
              <div class="progress-level" id="level">1</div>
              <div class="progress-title" id="title">èª­æ›¸ãƒ“ã‚®ãƒŠãƒ¼</div>
            </div>
          </div>
          <div class="progress-xp"><span id="xp">0</span> / 5 XP</div>
        </section>
        <div class="stats">
          <div class="stat"><div class="stat-value" id="time">0:00</div><div class="stat-label">ç´¯è¨ˆ</div></div>
          <div class="stat"><div class="stat-value" id="sessions">0</div><div class="stat-label">å›æ•°</div></div>
          <div class="stat"><div class="stat-value" id="books">0</div><div class="stat-label">èª­äº†</div></div>
        </div>
        <button class="action-btn start" id="startBtn" onclick="toggleTimer()">èª­æ›¸ã‚’ã¯ã˜ã‚ã‚‹</button>
        <div class="quote">
          <p class="quote-text" id="quoteText">èª­æ›¸ã¯å¿ƒã®æ—…è·¯ã€‚ä¸€ãƒšãƒ¼ã‚¸ãŒæ–°ã—ã„ä¸–ç•Œã¸ã®æ‰‰ã¨ãªã‚‹ã€‚</p>
          <p class="quote-author" id="quoteAuthor">â€” ä»Šæ—¥ã®ä¸€è¨€</p>
        </div>
      </main>
    </div>

```
<!-- Books Tab -->
<div class="tab" id="tab-books">
  <header class="header">
    <h1 class="header-title">æœ¬æ£š</h1>
    <button class="header-btn primary" onclick="openAddBook()">+</button>
  </header>
  <main class="main">
    <div class="bookshelf">
      <div class="bookshelf-header">
        <div class="bookshelf-title">ğŸ“š My Library</div>
        <div class="bookshelf-count" id="bookCount">0</div>
        <div class="bookshelf-label">å†Šèª­äº†</div>
      </div>
      <div class="bookshelf-scroll">
        <div class="bookshelf-cabinet" id="shelf"></div>
      </div>
      <div class="bookshelf-hint" id="shelfHint">â† ã‚¹ãƒ¯ã‚¤ãƒ—ã§æ›¸æ–ã‚’æ¢ç´¢ â†’</div>
    </div>
    <div id="bookList"></div>
  </main>
</div>

<!-- Stats Tab -->
<div class="tab" id="tab-stats">
  <header class="header">
    <h1 class="header-title">èª­æ›¸ã®è¨˜éŒ²</h1>
  </header>
  <main class="main">
    <div class="impact">
      <div class="impact-value" id="impactBooks">0å†Š</div>
      <div class="impact-label">èª­ç ´ã—ãŸæœ¬</div>
      <div class="impact-sub" id="impactSub"></div>
    </div>
    <div class="stats-grid">
      <div class="stats-card"><div class="stats-card-value" id="totalHours">0</div><div class="stats-card-label">æ™‚é–“</div></div>
      <div class="stats-card"><div class="stats-card-value" id="totalSessions">0</div><div class="stats-card-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³</div></div>
      <div class="stats-card"><div class="stats-card-value" id="daysSince">1</div><div class="stats-card-label">æ—¥ç›®</div></div>
    </div>
    <h3 class="section-title">ä»Šé€±ã®èª­æ›¸</h3>
    <div class="week-chart" id="weekChart"></div>
    <h3 class="section-title">ã‚ãªãŸã®ã‚¹ã‚¿ã‚¤ãƒ«</h3>
    <div class="style-card"><span class="style-icon">ğŸ¯</span><div><div class="style-value" id="avgFocus">--</div><div class="style-label">å¹³å‡ã®é›†ä¸­æ™‚é–“</div></div></div>
    <div class="style-card"><span class="style-icon" id="timeIcon">ğŸŒ™</span><div><div class="style-value" id="timeType">--</div><div class="style-label">ã‚ˆãèª­ã‚€æ™‚é–“å¸¯</div></div></div>
    <div class="tip"><span class="tip-icon">ğŸ’¡</span><span class="tip-text" id="tipText">èª­æ›¸ã‚’å§‹ã‚ã¦è¨˜éŒ²ã‚’ä½œã‚ã†</span></div>
  </main>
</div>

<!-- Nav -->
<nav class="nav">
  <button class="nav-item active" onclick="switchTab('home')"><span>ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span></button>
  <button class="nav-item" onclick="switchTab('books')"><span>ğŸ“š</span><span>æœ¬æ£š</span></button>
  <button class="nav-item" onclick="switchTab('stats')"><span>ğŸ“Š</span><span>è¨˜éŒ²</span></button>
</nav>
```

  </div>

  <!-- Reading Screen -->

  <div class="reading" id="reading">
    <div class="flame">
      <div class="flame-glow"></div>
      <div class="flame-shape flame-outer"></div>
      <div class="flame-shape flame-inner"></div>
    </div>
    <p class="reading-label">èª­æ›¸ã«é›†ä¸­ã—ã¦ã„ã¾ã™</p>
    <button class="reading-stop" onclick="stopReading()">èª­æ›¸ã‚’ãŠã‚ã‚‹</button>
  </div>

  <!-- Add Book Modal -->

  <div class="modal-bg" id="addBookModal" onclick="closeAddBook(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-bar"></div>
      <div class="modal-header">
        <h2 class="modal-title">èª­äº†ã‚’è¨˜éŒ²</h2>
        <button class="modal-close" onclick="closeAddBook()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="celebration"><span class="celebration-icon">ğŸŠ</span><p class="celebration-text">1å†Šèª­ã¿çµ‚ãˆãŸè‡ªåˆ†ã‚’è¤’ã‚ã‚ˆã†</p></div>
        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" class="form-input" id="bookInput" placeholder="ä¾‹ï¼šäººã‚’å‹•ã‹ã™">
        </div>
        <div class="form-group">
          <button class="link-toggle" onclick="toggleLink()"><span id="linkIcon">+</span><span>ãƒªãƒ³ã‚¯ã‚’è¿½åŠ </span></button>
          <div class="link-fields" id="linkFields">
            <div class="input-with-btn">
              <input type="url" class="form-input" id="linkInput" placeholder="Amazonã‚„æ›¸è©•ã¸ã®ãƒªãƒ³ã‚¯">
              <button type="button" class="paste-btn" onclick="pasteLink('linkInput')">ğŸ“‹</button>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addBook(true)"><span>èª­äº†ï¼</span><span class="btn-badge">+10 XP</span></button>
        <button class="btn btn-secondary" onclick="addBook(false)">éå»ã«èª­ã‚“ã æœ¬ã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- Edit Book Modal -->

  <div class="modal-bg" id="editBookModal" onclick="closeEditBook(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-bar"></div>
      <div class="modal-header">
        <h2 class="modal-title">æœ¬ã‚’ç·¨é›†</h2>
        <button class="modal-close" onclick="closeEditBook()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" class="form-input" id="editBookTitle" placeholder="ä¾‹ï¼šäººã‚’å‹•ã‹ã™">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒªãƒ³ã‚¯ï¼ˆä»»æ„ï¼‰</label>
          <div class="input-with-btn">
            <input type="url" class="form-input" id="editBookLink" placeholder="Amazonã‚„æ›¸è©•ã¸ã®ãƒªãƒ³ã‚¯">
            <button type="button" class="paste-btn" onclick="pasteLink('editBookLink')">ğŸ“‹</button>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveEditBook()">ä¿å­˜</button>
        <button class="btn btn-secondary" onclick="closeEditBook()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->

  <div class="modal-bg" id="settingsModal" onclick="closeSettings(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-bar"></div>
      <div class="modal-header">
        <h2 class="modal-title">è¨­å®š</h2>
        <button class="modal-close" onclick="closeSettings()">Ã—</button>
      </div>
      <div class="modal-body">
        <button class="btn btn-danger" onclick="confirmReset()">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <p class="settings-hint">èª­æ›¸è¨˜éŒ²ãƒ»XPãƒ»ç™»éŒ²ã—ãŸæœ¬ãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™</p>
      </div>
    </div>
  </div>

  <!-- Level Up -->

  <div class="overlay" id="levelUp" onclick="closeLevelUp()">
    <div class="overlay-content">
      <div class="overlay-icon">â¬†ï¸</div>
      <div class="overlay-label">LEVEL UP</div>
      <div class="overlay-value" id="newLevel">Lv.2</div>
      <button class="overlay-btn">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- New Title -->

  <div class="overlay" id="newTitle" onclick="closeNewTitle()">
    <div class="overlay-content">
      <div class="overlay-icon" id="newTitleIcon">ğŸ“–</div>
      <div class="overlay-label">NEW TITLE</div>
      <div class="overlay-value" id="newTitleName">æœ¬ã®è™«</div>
      <div class="overlay-sub" id="newTitleSub">å°‘ã—ãšã¤ç¿’æ…£ã«</div>
      <button class="overlay-btn">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- Reset Confirm -->

  <div class="confirm" id="resetConfirm">
    <div class="confirm-box">
      <div class="confirm-icon">âš ï¸</div>
      <div class="confirm-title">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</div>
      <div class="confirm-text">ã™ã¹ã¦ã®è¨˜éŒ²ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</div>
      <div class="confirm-btns">
        <button class="confirm-cancel" onclick="cancelReset()">ã„ã„ãˆ</button>
        <button class="confirm-ok" onclick="executeReset()">ã¯ã„</button>
      </div>
    </div>
  </div>

  <!-- Delete Book Confirm -->

  <div class="confirm" id="deleteBookConfirm">
    <div class="confirm-box">
      <div class="confirm-icon">ğŸ“•</div>
      <div class="confirm-title">ã€Œ<span id="deleteBookTitle"></span>ã€</div>
      <div class="confirm-text">å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="confirm-btns">
        <button class="confirm-cancel" onclick="cancelDeleteBook()">ã„ã„ãˆ</button>
        <button class="confirm-ok" onclick="executeDeleteBook()">ã¯ã„</button>
      </div>
    </div>
  </div>

<script>
// ========================================
// å®šæ•°
// ========================================
const STORAGE_KEY = 'readingLogV4';
const XP_PER_LEVEL = 5;
const XP_PER_BOOK = 10;
const MIN_SESSION_MINUTES = 10;

const TITLES = [
  { lv: 1, name: 'èª­æ›¸ãƒ“ã‚®ãƒŠãƒ¼', sub: 'èª­æ›¸ã®æ—…ãŒå§‹ã¾ã‚‹', icon: 'ğŸŒ±' },
  { lv: 3, name: 'æœ¬ã®è™«', sub: 'å°‘ã—ãšã¤ç¿’æ…£ã«', icon: 'ğŸ›' },
  { lv: 5, name: 'èª­æ›¸å®¶', sub: 'èª­æ›¸ãŒæ—¥å¸¸ã«ãªã£ãŸ', icon: 'ğŸ“–' },
  { lv: 10, name: 'èª­æ›¸ãƒãƒ‹ã‚¢', sub: 'æœ¬ãªã—ã§ã¯ç”Ÿãã‚‰ã‚Œãªã„', icon: 'ğŸ“š' },
  { lv: 20, name: 'èª­æ›¸ãƒã‚¹ã‚¿ãƒ¼', sub: 'çŸ¥è­˜ã®æ¢æ±‚è€…', icon: 'ğŸ“' },
  { lv: 35, name: 'èª­æ›¸ã®é”äºº', sub: 'æœ¬ã¨å…±ã«ç”Ÿãã‚‹', icon: 'âš”ï¸' },
  { lv: 50, name: 'èª­æ›¸ç‹', sub: 'æ›¸ç‰©ã®ç‹å›½ã®ä¸»', icon: 'ğŸ‘‘' },
  { lv: 75, name: 'èª­æ›¸ã®è³¢è€…', sub: 'ç„¡é™ã®çŸ¥æµ', icon: 'ğŸ§™' },
  { lv: 100, name: 'èª­æ›¸ç¥', sub: 'ç¥ã®é ˜åŸŸã¸', icon: 'âœ¨' }
];

const QUOTES = [
  { text: 'èª­æ›¸ã¯å¿ƒã®æ—…è·¯ã€‚ä¸€ãƒšãƒ¼ã‚¸ãŒæ–°ã—ã„ä¸–ç•Œã¸ã®æ‰‰ã¨ãªã‚‹ã€‚', author: 'ä»Šæ—¥ã®ä¸€è¨€' },
  { text: 'æœ¬ã‚’èª­ã‚€ã“ã¨ã¯ã€ä»–äººã®é ­ã§è€ƒãˆã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚', author: 'ã‚·ãƒ§ãƒ¼ãƒšãƒ³ãƒã‚¦ã‚¢ãƒ¼' },
  { text: 'è‰¯æ›¸ã¯æœ€è‰¯ã®å‹äººã§ã‚ã‚‹ã€‚', author: 'ãƒ—ãƒ­ãƒ´ã‚¡ãƒ¼ãƒ–' },
  { text: 'çŸ¥è­˜ã¸ã®æŠ•è³‡ã¯ã€å¸¸ã«æœ€é«˜ã®åˆ©æ¯ãŒã¤ãã€‚', author: 'ãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³ãƒ»ãƒ•ãƒ©ãƒ³ã‚¯ãƒªãƒ³' },
  { text: 'æœ¬ã¯å¿ƒã®ç³§ã€‚æ¯æ—¥å°‘ã—ãšã¤å‘³ã‚ãŠã†ã€‚', author: 'ä»Šæ—¥ã®ä¸€è¨€' }
];

const MILESTONES = [10, 30, 60, 120, 300, 600, 1000, 1440];

const BOOK_COLORS = [
  ['#c62828', '#b71c1c'], ['#1565c0', '#0d47a1'], ['#2e7d32', '#1b5e20'],
  ['#6a1b9a', '#4a148c'], ['#e65100', '#bf360c'], ['#00695c', '#004d40'],
  ['#37474f', '#263238'], ['#8d6e63', '#5d4037'], ['#d84315', '#bf360c'],
  ['#0277bd', '#01579b']
];

// ========================================
// çŠ¶æ…‹ç®¡ç†
// ========================================
let state = loadState();
let timer = null;
let seconds = 0;
let deletingBookId = null;
let editingBookId = null;

function createInitialState() {
  return {
    total: 0,
    today: 0,
    date: new Date().toDateString(),
    sessions: 0,
    xp: 0,
    lv: 1,
    books: [],
    history: [],
    milestones: []
  };
}

function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ä»Šæ—¥ã®æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (parsed.date !== new Date().toDateString()) {
        parsed.today = 0;
        parsed.date = new Date().toDateString();
      }
      return parsed;
    }
  } catch (e) {
    console.error('Failed to load state:', e);
  }
  return createInitialState();
}

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.error('Failed to save state:', e);
  }
}

// ========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ========================================
function getTitle(level) {
  for (let i = TITLES.length - 1; i >= 0; i--) {
    if (level >= TITLES[i].lv) return TITLES[i];
  }
  return TITLES[0];
}

function formatTime(minutes) {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hours}:${mins.toString().padStart(2, '0')}`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function isValidUrl(str) {
  return str && /^https?:\/\//i.test(str);
}

function getRandomQuote() {
  return QUOTES[Math.floor(Math.random() * QUOTES.length)];
}

// ========================================
// UIæ›´æ–°
// ========================================
function updateUI() {
  const title = getTitle(state.lv);
  
  // ãƒ¬ãƒ™ãƒ«ãƒ»ç§°å·
  document.getElementById('level').textContent = state.lv;
  document.getElementById('title').textContent = title.name;
  
  // XPãƒªãƒ³ã‚° (circumference = 2 * Ï€ * 66 â‰ˆ 414.69)
  const circumference = 414.69;
  const xpInLevel = state.xp % XP_PER_LEVEL;
  document.getElementById('xp').textContent = xpInLevel;
  const percent = (xpInLevel / XP_PER_LEVEL) * 100;
  document.getElementById('ring').style.strokeDashoffset = circumference - (percent / 100 * circumference);
  
  // çµ±è¨ˆ
  document.getElementById('time').textContent = formatTime(state.total);
  document.getElementById('sessions').textContent = state.sessions;
  document.getElementById('books').textContent = state.books.length;
  
  // åè¨€
  const quote = getRandomQuote();
  document.getElementById('quoteText').textContent = quote.text;
  document.getElementById('quoteAuthor').textContent = `â€” ${quote.author}`;
  
  saveState();
}

// ========================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ========================================
function switchTab(name) {
  const tabs = ['home', 'books', 'stats'];
  
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  document.getElementById(`tab-${name}`).classList.add('active');
  document.querySelectorAll('.nav-item')[tabs.indexOf(name)].classList.add('active');
  
  if (name === 'books') renderBooks();
  if (name === 'stats') renderStats();
}

// ========================================
// ã‚¿ã‚¤ãƒãƒ¼
// ========================================
function toggleTimer() {
  timer ? stopReading() : startReading();
}

function startReading() {
  if (timer) return;
  
  seconds = 0;
  document.getElementById('reading').classList.add('active');
  timer = setInterval(() => seconds++, 1000);
  
  const btn = document.getElementById('startBtn');
  btn.textContent = 'èª­æ›¸ä¸­...';
  btn.classList.replace('start', 'stop');
}

function stopReading() {
  clearInterval(timer);
  timer = null;
  
  document.getElementById('reading').classList.remove('active');
  
  const minutes = Math.floor(seconds / 60);
  state.total += minutes;
  state.today += minutes;
  
  if (minutes >= MIN_SESSION_MINUTES) {
    state.sessions++;
    state.history.push({
      d: new Date().toISOString(),
      m: minutes,
      h: new Date().getHours()
    });
    const bonusXP = Math.floor(minutes / 10);
    addXP(1 + bonusXP);
  }
  
  checkMilestones();
  
  const btn = document.getElementById('startBtn');
  btn.textContent = 'èª­æ›¸ã‚’ã¯ã˜ã‚ã‚‹';
  btn.classList.replace('stop', 'start');
  
  seconds = 0;
  updateUI();
}

// ========================================
// XPãƒ»ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
// ========================================
function addXP(amount) {
  const oldLevel = state.lv;
  state.xp += amount;
  state.lv = Math.floor(state.xp / XP_PER_LEVEL) + 1;
  
  if (state.lv > oldLevel) {
    showLevelUp(state.lv);
    const oldTitle = getTitle(oldLevel);
    const newTitle = getTitle(state.lv);
    if (newTitle.name !== oldTitle.name) {
      setTimeout(() => showNewTitle(newTitle), 2000);
    }
  }
}

function showLevelUp(level) {
  document.getElementById('newLevel').textContent = `Lv.${level}`;
  document.getElementById('levelUp').classList.add('active');
  showConfetti();
}

function closeLevelUp() {
  document.getElementById('levelUp').classList.remove('active');
}

function showNewTitle(title) {
  document.getElementById('newTitleIcon').textContent = title.icon;
  document.getElementById('newTitleName').textContent = title.name;
  document.getElementById('newTitleSub').textContent = title.sub;
  document.getElementById('newTitle').classList.add('active');
}

function closeNewTitle() {
  document.getElementById('newTitle').classList.remove('active');
}

// ========================================
// ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³
// ========================================
function checkMilestones() {
  for (const milestone of MILESTONES) {
    if (state.total >= milestone && !state.milestones.includes(milestone)) {
      state.milestones.push(milestone);
      showMilestone(milestone);
      break;
    }
  }
}

function showMilestone(minutes) {
  const messages = [
    `${Math.floor(minutes / 60)}æ™‚é–“é”æˆï¼`,
    `æ˜ ç”»${Math.floor(minutes / 120)}æœ¬åˆ†ï¼`,
    `YouTube${Math.floor(minutes / 10)}æœ¬åˆ†ï¼`
  ];
  const message = minutes >= 60 
    ? messages[Math.floor(Math.random() * messages.length)] 
    : `${minutes}åˆ†é”æˆï¼`;
  
  const el = document.createElement('div');
  el.className = 'milestone';
  el.innerHTML = `
    <div class="milestone-icon">ğŸ‰</div>
    <div class="milestone-title">ç´¯è¨ˆ ${minutes >= 60 ? Math.floor(minutes / 60) + 'æ™‚é–“' : minutes + 'åˆ†'}</div>
    <div class="milestone-text">${message}</div>
  `;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ========================================
// æœ¬æ£š
// ========================================
function renderBooks() {
  const shelf = document.getElementById('shelf');
  const hint = document.getElementById('shelfHint');
  const bookList = document.getElementById('bookList');
  
  document.getElementById('bookCount').textContent = state.books.length;
  
  if (!state.books.length) {
    shelf.innerHTML = '<div class="bookshelf-empty">ã¾ã æœ¬ãŒã‚ã‚Šã¾ã›ã‚“<br>èª­äº†ã—ãŸæœ¬ã‚’è¿½åŠ ã—ã‚ˆã†</div>';
    hint.style.display = 'none';
    bookList.innerHTML = '';
    return;
  }
  
  // æœ¬æ£šã®æç”»
  let bookIndex = 0;
  const booksHtml = state.books.map(book => {
    const seed = ((book.id * 13) ^ (book.id >> 8)) + bookIndex * 137;
    bookIndex++;
    const colorIndex = Math.abs(seed) % BOOK_COLORS.length;
    const color = BOOK_COLORS[colorIndex];
    const height = 36 + Math.abs(seed * 7) % 18;
    const hasLink = isValidUrl(book.link);
    const linkBtn = hasLink 
      ? `<a href="${escapeHtml(book.link)}" target="_blank" rel="noopener" class="tooltip-link">ğŸ”— é–‹ã</a>` 
      : '';
    return `<div class="bookshelf-book" style="height:${height}px;background:linear-gradient(to right,${color[0]},${color[1]},${color[0]})">
      <span class="book-tooltip">${escapeHtml(book.title)}${linkBtn}</span>
    </div>`;
  }).join('');
  
  shelf.innerHTML = `<div class="bookshelf-row">${booksHtml}</div>`;
  hint.style.display = state.books.length > 15 ? 'block' : 'none';
  
  // ãƒªã‚¹ãƒˆè¡¨ç¤º
  bookList.innerHTML = [...state.books].reverse().map(book => {
    const safeLink = isValidUrl(book.link) ? escapeHtml(book.link) : null;
    const titleHtml = safeLink 
      ? `<a href="${safeLink}" target="_blank" rel="noopener">${escapeHtml(book.title)}</a>` 
      : escapeHtml(book.title);
    const xpBadge = book.xp ? '<span class="book-xp">+10 XP</span>' : '';
    
    return `
      <div class="book-item">
        <div class="book-cover">ğŸ“•</div>
        <div class="book-info">
          <div class="book-title">${titleHtml}</div>
          <div class="book-meta">${new Date(book.id).toLocaleDateString('ja-JP')}${xpBadge}</div>
        </div>
        <button class="book-edit" onclick="openEditBook(${book.id})">âœï¸</button>
        <button class="book-delete" onclick="deleteBook(${book.id})">Ã—</button>
      </div>
    `;
  }).join('');
}

function openAddBook() {
  document.getElementById('addBookModal').classList.add('active');
}

function closeAddBook(e) {
  if (!e || e.target === e.currentTarget) {
    document.getElementById('addBookModal').classList.remove('active');
    document.getElementById('bookInput').value = '';
    document.getElementById('linkInput').value = '';
    document.getElementById('linkFields').classList.remove('open');
    document.getElementById('linkIcon').textContent = '+';
  }
}

function toggleLink() {
  const fields = document.getElementById('linkFields');
  const isOpen = fields.classList.toggle('open');
  document.getElementById('linkIcon').textContent = isOpen ? 'âˆ’' : '+';
}

function addBook(withXP) {
  const title = document.getElementById('bookInput').value.trim();
  if (!title) {
    showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  const link = document.getElementById('linkInput').value.trim();
  
  state.books.push({
    id: Date.now(),
    title,
    link: link || null,
    xp: withXP
  });
  
  if (withXP) {
    addXP(XP_PER_BOOK);
    showConfetti();
    showToast('1å†Šèª­ç ´ï¼+10 XP');
  } else {
    showToast('æœ¬ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
  }
  
  renderBooks();
  updateUI();
  closeAddBook();
}

function deleteBook(id) {
  deletingBookId = id;
  const book = state.books.find(b => b.id === id);
  if (book) {
    document.getElementById('deleteBookTitle').textContent = book.title;
    document.getElementById('deleteBookConfirm').classList.add('active');
  }
}

function cancelDeleteBook() {
  document.getElementById('deleteBookConfirm').classList.remove('active');
  deletingBookId = null;
}

function executeDeleteBook() {
  const book = state.books.find(b => b.id === deletingBookId);
  if (book?.xp) {
    state.xp = Math.max(0, state.xp - XP_PER_BOOK);
    state.lv = Math.floor(state.xp / XP_PER_LEVEL) + 1;
  }
  state.books = state.books.filter(b => b.id !== deletingBookId);
  
  saveState();
  renderBooks();
  updateUI();
  showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
  cancelDeleteBook();
}

function openEditBook(id) {
  const book = state.books.find(b => b.id === id);
  if (!book) return;
  
  editingBookId = id;
  document.getElementById('editBookTitle').value = book.title;
  document.getElementById('editBookLink').value = book.link || '';
  document.getElementById('editBookModal').classList.add('active');
}

function closeEditBook(e) {
  if (!e || e.target === e.currentTarget) {
    document.getElementById('editBookModal').classList.remove('active');
    editingBookId = null;
  }
}

function saveEditBook() {
  const title = document.getElementById('editBookTitle').value.trim();
  if (!title) {
    showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  const link = document.getElementById('editBookLink').value.trim();
  const book = state.books.find(b => b.id === editingBookId);
  
  if (book) {
    book.title = title;
    book.link = link || null;
    saveState();
    renderBooks();
    showToast('ä¿å­˜ã—ã¾ã—ãŸ');
  }
  closeEditBook();
}

// ========================================
// çµ±è¨ˆ
// ========================================
function renderStats() {
  document.getElementById('impactBooks').textContent = state.books.length + 'å†Š';
  
  const impactSub = document.getElementById('impactSub');
  if (state.total >= 60) {
    impactSub.textContent = `${Math.floor(state.total / 60)}æ™‚é–“ã®èª­æ›¸ã§ç©ã¿ä¸Šã’ãŸæˆæœ`;
  } else if (state.total > 0) {
    impactSub.textContent = `${state.total}åˆ†ã®èª­æ›¸ã§ç©ã¿ä¸Šã’ãŸæˆæœ`;
  } else {
    impactSub.textContent = '';
  }
  
  document.getElementById('totalHours').textContent = Math.floor(state.total / 60);
  document.getElementById('totalSessions').textContent = state.sessions;
  
  const days = state.history.length 
    ? Math.max(1, Math.ceil((Date.now() - new Date(state.history[0].d)) / 86400000)) 
    : 1;
  document.getElementById('daysSince').textContent = days;
  
  renderWeekChart();
  renderStyle();
  renderTip();
}

function renderWeekChart() {
  const el = document.getElementById('weekChart');
  const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const now = new Date();
  const data = [];
  let max = 0;
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    const minutes = state.history
      .filter(h => h.d.startsWith(dateStr))
      .reduce((sum, h) => sum + h.m, 0);
    max = Math.max(max, minutes);
    data.push({
      label: dayNames[date.getDay()],
      minutes,
      isToday: i === 0
    });
  }
  
  max = Math.max(max, 30);
  
  el.innerHTML = data.map(d => {
    const height = d.minutes ? Math.max(8, Math.round(d.minutes / max * 60)) : 4;
    const fillClass = `week-bar-fill${d.minutes ? '' : ' empty'}${d.isToday ? ' today' : ''}`;
    const labelClass = `week-bar-label${d.isToday ? ' today' : ''}`;
    return `<div class="week-bar">
      <div class="${fillClass}" style="height:${height}px"></div>
      <span class="${labelClass}">${d.label}</span>
    </div>`;
  }).join('');
}

function renderStyle() {
  const history = state.history;
  
  // å¹³å‡é›†ä¸­æ™‚é–“
  const avgFocus = document.getElementById('avgFocus');
  avgFocus.textContent = history.length 
    ? Math.round(history.reduce((sum, h) => sum + h.m, 0) / history.length) + 'åˆ†' 
    : '--';
  
  // èª­æ›¸æ™‚é–“å¸¯
  const timeType = document.getElementById('timeType');
  const timeIcon = document.getElementById('timeIcon');
  
  if (history.length >= 3) {
    const hours = history.map(h => h.h);
    const counts = [
      hours.filter(h => h >= 5 && h < 12).length,   // æœ
      hours.filter(h => h >= 12 && h < 18).length,  // æ˜¼
      hours.filter(h => h >= 18 && h < 22).length,  // å¤œ
      hours.filter(h => h >= 22 || h < 5).length    // æ·±å¤œ
    ];
    const maxIndex = counts.indexOf(Math.max(...counts));
    const types = [
      ['æœå‹', 'ğŸŒ…'],
      ['æ˜¼å‹', 'â˜€ï¸'],
      ['å¤œå‹', 'ğŸŒ™'],
      ['æ·±å¤œå‹', 'ğŸŒƒ']
    ];
    timeType.textContent = types[maxIndex][0];
    timeIcon.textContent = types[maxIndex][1];
  } else {
    timeType.textContent = '--';
    timeIcon.textContent = 'ğŸŒ™';
  }
}

function renderTip() {
  const tipEl = document.getElementById('tipText');
  const tips = [];
  
  if (state.books.length > 0 && state.total > 0) {
    tips.push(`å¹³å‡1å†Šã‚ãŸã‚Š${Math.round(state.total / state.books.length)}åˆ†`);
  }
  if (state.total >= 60) {
    tips.push(`åˆè¨ˆ${Math.floor(state.total / 60)}æ™‚é–“èª­æ›¸`);
  }
  if (state.total >= 120) {
    tips.push(`æ˜ ç”»${Math.floor(state.total / 120)}æœ¬åˆ†ã®æ™‚é–“`);
  }
  if (state.total > 0) {
    tips.push(`YouTube${Math.floor(state.total / 10)}æœ¬åˆ†ã‚’èª­æ›¸ã«`);
  }
  
  tipEl.textContent = tips.length 
    ? tips[Math.floor(Math.random() * tips.length)] 
    : 'èª­æ›¸ã‚’å§‹ã‚ã¦è¨˜éŒ²ã‚’ä½œã‚ã†';
}

// ========================================
// è¨­å®š
// ========================================
function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
}

function closeSettings(e) {
  if (!e || e.target === e.currentTarget) {
    document.getElementById('settingsModal').classList.remove('active');
  }
}

function confirmReset() {
  document.getElementById('resetConfirm').classList.add('active');
}

function cancelReset() {
  document.getElementById('resetConfirm').classList.remove('active');
}

function executeReset() {
  localStorage.removeItem(STORAGE_KEY);
  state = createInitialState();
  updateUI();
  document.getElementById('resetConfirm').classList.remove('active');
  closeSettings();
  showToast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}

// ========================================
// ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
// ========================================
function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function showConfetti() {
  const container = document.createElement('div');
  container.className = 'confetti';
  const colors = ['#e8a87c', '#f0c27b', '#7dd3a8', '#6b5b95', '#f87171'];
  
  for (let i = 0; i < 40; i++) {
    const piece = document.createElement('i');
    piece.style.cssText = `
      left: ${Math.random() * 100}%;
      background: ${colors[i % 5]};
      animation-delay: ${Math.random() * 0.4}s;
      animation-duration: ${2 + Math.random()}s;
    `;
    container.appendChild(piece);
  }
  
  document.body.appendChild(container);
  setTimeout(() => container.remove(), 3000);
}

async function pasteLink(inputId) {
  const input = document.getElementById(inputId);
  try {
    const text = await navigator.clipboard.readText();
    input.value = text;
    input.focus();
    showToast('ãƒšãƒ¼ã‚¹ãƒˆã—ã¾ã—ãŸ');
  } catch (e) {
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦æ‰‹å‹•ãƒšãƒ¼ã‚¹ãƒˆã‚’ä¿ƒã™
    input.focus();
    showToast('å…¥åŠ›æ¬„ã‚’é•·æŠ¼ã—ã—ã¦ãƒšãƒ¼ã‚¹ãƒˆ');
  }
}

// ========================================
// åˆæœŸåŒ–
// ========================================
updateUI();
</script>

</body>
</html>