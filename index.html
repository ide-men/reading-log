<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0f">
  <title>èª­æ›¸ãƒ­ã‚°</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --elevated: #1a1a25;
  --accent: #e8a87c;
  --accent-glow: rgba(232, 168, 124, 0.25);
  --text: #f5f5f7;
  --text-dim: #6b6b7a;
  --border: rgba(255, 255, 255, 0.06);
}

html, body {
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--bg);
  color: #c9c9d0;
}

/* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠ - çµ¶å¯¾é…ç½®ã§ç¢ºå®Ÿã« */
.app {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  max-width: 430px;
  margin: 0 auto;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: var(--bg);
}

.header h1 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.header-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
}

.header-btn.primary {
  background: var(--accent);
  border: none;
  color: var(--bg);
  font-size: 22px;
}

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
.content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 20px 100px;
  -webkit-overflow-scrolling: touch;
}

/* ã‚¿ãƒ– */
.tab {
  display: none;
}

.tab.active {
  display: block;
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 8px 0;
  padding-bottom: max(8px, env(safe-area-inset-bottom));
  max-width: 430px;
  margin: 0 auto;
}

.nav button {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px;
  background: none;
  border: none;
  cursor: pointer;
}

.nav button span:first-child {
  font-size: 22px;
}

.nav button span:last-child {
  font-size: 10px;
  color: var(--text-dim);
}

.nav button.active span:last-child {
  color: var(--accent);
  font-weight: 500;
}

/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚° */
.progress {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 0;
}

.ring-wrapper {
  position: relative;
  width: 150px;
  height: 150px;
}

.ring-wrapper svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.ring-wrapper circle {
  fill: none;
  stroke-width: 7;
}

.ring-bg {
  stroke: var(--elevated);
}

.ring-fill {
  stroke: var(--accent);
  stroke-linecap: round;
  stroke-dasharray: 414.69;
  stroke-dashoffset: 414.69;
  transition: stroke-dashoffset 0.5s;
}

.ring-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.ring-level {
  font-size: 34px;
  font-weight: 700;
  color: var(--text);
}

.ring-title {
  font-size: 12px;
  color: var(--accent);
  margin-top: 2px;
}

.xp-text {
  font-size: 12px;
  color: var(--text-dim);
  margin-top: 10px;
}

.xp-text span {
  color: var(--accent);
  font-weight: 700;
}

/* ãƒœã‚¿ãƒ³ */
.main-btn {
  width: 100%;
  padding: 16px;
  font-size: 16px;
  font-weight: 700;
  font-family: inherit;
  border: none;
  border-radius: 24px;
  cursor: pointer;
  background: linear-gradient(135deg, var(--accent), #d4956a);
  color: var(--bg);
  box-shadow: 0 0 40px var(--accent-glow);
}

.main-btn:active {
  transform: scale(0.98);
}

/* å¼•ç”¨ */
.quote {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 14px 16px;
  margin-top: 14px;
}

.quote p:first-child {
  font-size: 13px;
  font-style: italic;
  line-height: 1.7;
}

.quote p:last-child {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 6px;
  text-align: right;
}

/* æœ¬æ£šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.bookshelf {
  background: linear-gradient(to bottom, #1a1410, var(--surface) 70%);
  margin: 0 -20px 20px;
  padding: 20px;
  text-align: center;
}

.bookshelf-title {
  font-size: 12px;
  color: var(--accent);
  letter-spacing: 0.15em;
  margin-bottom: 4px;
}

.bookshelf-count {
  font-size: 36px;
  font-weight: 700;
  color: var(--text);
}

.bookshelf-label {
  font-size: 13px;
  color: var(--text-dim);
}

/* æœ¬æ£šãƒ•ãƒ¬ãƒ¼ãƒ  */
.shelf-container {
  margin-top: 20px;
  background: linear-gradient(135deg, #2a1f18 0%, #3d2e24 50%, #2a1f18 100%);
  border: 4px solid #1a1410;
  border-radius: 8px;
  padding: 0 8px;
  box-shadow:
    inset 0 0 20px rgba(0,0,0,0.4),
    0 8px 20px rgba(0,0,0,0.5);
  position: relative;
}

/* æœ¨ç›®ãƒ†ã‚¯ã‚¹ãƒãƒ£ */
.shelf-container::before {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    90deg,
    transparent 0px,
    rgba(255,255,255,0.02) 1px,
    transparent 2px,
    transparent 20px
  );
  pointer-events: none;
  border-radius: 4px;
}

.shelf-visual {
  display: flex;
  justify-content: flex-start;
  align-items: flex-end;
  gap: 4px;
  min-height: 80px;
  padding: 12px 8px 0;
  overflow-x: auto;
  overflow-y: visible;
  flex-wrap: nowrap;
  position: relative;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--elevated);
}

.shelf-visual::-webkit-scrollbar {
  height: 6px;
}

.shelf-visual::-webkit-scrollbar-track {
  background: var(--elevated);
  border-radius: 3px;
}

.shelf-visual::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

/* æ£šæ¿ */
.shelf-board {
  position: relative;
  margin-bottom: 4px;
}

.shelf-board::after {
  content: '';
  display: block;
  height: 12px;
  background: linear-gradient(to bottom,
    #5a4a3a 0%,
    #4a3a2a 40%,
    #3a2a1a 100%
  );
  border-radius: 0 0 4px 4px;
  box-shadow:
    0 4px 8px rgba(0,0,0,0.4),
    inset 0 2px 0 rgba(255,255,255,0.1);
  margin-top: -2px;
}

/* æœ¬ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.mini-book {
  min-width: 14px;
  border-radius: 2px 3px 0 0;
  cursor: pointer;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.2s ease;
  box-shadow:
    2px 0 0 rgba(0,0,0,0.3),
    -1px 0 0 rgba(255,255,255,0.1);
}

.mini-book::before {
  content: '';
  position: absolute;
  top: 4px;
  left: 2px;
  right: 2px;
  bottom: 4px;
  background: linear-gradient(
    to right,
    rgba(255,255,255,0.15) 0%,
    transparent 30%,
    transparent 70%,
    rgba(0,0,0,0.2) 100%
  );
  border-radius: 1px;
}

/* èƒŒè¡¨ç´™ã®è£…é£¾ç·š */
.mini-book::after {
  content: '';
  position: absolute;
  top: 6px;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 2px;
  background: rgba(255,255,255,0.2);
  border-radius: 1px;
}

.mini-book:hover {
  transform: translateY(-6px) scale(1.05) !important;
  z-index: 10;
  box-shadow:
    2px 0 0 rgba(0,0,0,0.3),
    -1px 0 0 rgba(255,255,255,0.1),
    0 8px 16px rgba(0,0,0,0.4);
}

/* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
.book-tooltip {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 12px;
  min-width: 140px;
  max-width: 200px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  pointer-events: none;
}

.mini-book:hover .book-tooltip,
.book-tooltip:hover {
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
}

.book-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--elevated);
}

.tooltip-title {
  font-size: 12px;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tooltip-title:not(:last-child) {
  margin-bottom: 6px;
}

.tooltip-btn {
  display: block;
  width: 100%;
  padding: 6px 10px;
  font-size: 11px;
  font-family: inherit;
  background: var(--accent);
  border: none;
  border-radius: 6px;
  color: var(--bg);
  cursor: pointer;
  text-align: center;
}

.empty-shelf {
  color: var(--text-dim);
  font-size: 13px;
  padding: 30px 20px;
  font-style: italic;
  opacity: 0.7;
}

/* æœ¬ãƒªã‚¹ãƒˆ */
.book-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border);
}

.book-icon {
  width: 40px;
  height: 54px;
  background: var(--elevated);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.book-info {
  flex: 1;
  min-width: 0;
}

.book-name {
  font-size: 14px;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.book-name a {
  color: inherit;
  text-decoration: none;
}

.book-date {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 2px;
}

.book-xp {
  background: rgba(232, 168, 124, 0.1);
  color: var(--accent);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  margin-left: 6px;
}

.book-actions {
  display: flex;
  gap: 4px;
}

.book-actions button {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 16px;
  padding: 8px;
  cursor: pointer;
}

/* è¨˜éŒ²ã‚¿ãƒ– */
.impact-card {
  background: linear-gradient(135deg, var(--accent), #d4956a);
  border-radius: 24px;
  padding: 28px;
  text-align: center;
  color: var(--bg);
  margin-bottom: 20px;
}

.impact-value {
  font-size: 40px;
  font-weight: 700;
}

.impact-label {
  font-size: 14px;
  opacity: 0.8;
}

.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: rgba(0,0,0,0.15);
  padding: 6px 12px;
  border-radius: 20px;
  margin-top: 12px;
}

.streak-fire {
  font-size: 16px;
}

.streak-count {
  font-size: 18px;
  font-weight: 700;
}

.streak-label {
  font-size: 12px;
  opacity: 0.9;
}

.prediction-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 20px;
}

.prediction-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 10px 0;
}

.prediction-item:not(:last-child) {
  border-bottom: 1px solid var(--border);
}

.prediction-icon {
  font-size: 24px;
}

.prediction-content {
  flex: 1;
}

.prediction-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
}

.prediction-label {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 2px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.stats-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  text-align: center;
}

.stats-card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--text);
}

.stats-card-label {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 2px;
}

.section-title {
  font-size: 12px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 12px;
}

.week-chart {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  height: 100px;
  padding: 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  margin-bottom: 20px;
}

.week-bar {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.week-bar-fill {
  width: 100%;
  max-width: 24px;
  background: var(--accent);
  border-radius: 4px 4px 0 0;
  min-height: 4px;
}

.week-bar-fill.empty {
  background: var(--elevated);
}

.week-bar span {
  font-size: 10px;
  color: var(--text-dim);
}

.week-bar.today span {
  color: var(--accent);
  font-weight: 500;
}

.style-card {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 14px 16px;
  margin-bottom: 10px;
}

.style-icon {
  font-size: 24px;
}

.style-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

.style-label {
  font-size: 11px;
  color: var(--text-dim);
}

.tip {
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(232, 168, 124, 0.1);
  border-radius: 16px;
  padding: 14px 16px;
  margin-top: 20px;
}

.tip span:first-child {
  font-size: 18px;
}

.tip span:last-child {
  font-size: 13px;
}

/* èª­æ›¸ç”»é¢ */
.reading-screen {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.reading-screen.active {
  display: flex;
}

.flame {
  width: 100px;
  height: 100px;
  margin-bottom: 40px;
  position: relative;
}

.flame-glow {
  position: absolute;
  inset: 0;
  background: radial-gradient(circle, var(--accent-glow), transparent 70%);
  border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}

.flame-icon {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 50px;
  animation: flicker 0.5s ease-in-out infinite alternate;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 0.4; }
  50% { transform: scale(1.15); opacity: 0.6; }
}

@keyframes flicker {
  0% { transform: translate(-50%, -50%) scale(1); }
  100% { transform: translate(-50%, -50%) scale(1.05); }
}

.reading-label {
  font-size: 15px;
  color: var(--text-dim);
  margin-bottom: 48px;
}

.reading-stop {
  padding: 14px 40px;
  font-size: 14px;
  font-family: inherit;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  cursor: pointer;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: flex-end;
  justify-content: center;
  z-index: 200;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: var(--surface);
  border-radius: 24px 24px 0 0;
  width: 100%;
  max-width: 430px;
  max-height: 85vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-bar {
  width: 36px;
  height: 4px;
  background: var(--text-dim);
  border-radius: 2px;
  margin: 12px auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 20px 16px;
}

.modal-header h2 {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.modal-close {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--elevated);
  border: none;
  border-radius: 8px;
  color: var(--text-dim);
  font-size: 18px;
  cursor: pointer;
}

.modal-body {
  padding: 0 20px 28px;
}

.celebration {
  text-align: center;
  padding: 16px 0 20px;
}

.celebration-icon {
  font-size: 40px;
}

.celebration-text {
  font-size: 14px;
  color: var(--text-dim);
  margin-top: 8px;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 6px;
}

.form-input {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  font-family: inherit;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
}

.btn {
  width: 100%;
  padding: 16px;
  font-size: 15px;
  font-weight: 700;
  font-family: inherit;
  border: none;
  border-radius: 12px;
  cursor: pointer;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), #d4956a);
  color: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.btn-secondary {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-dim);
  margin-top: 10px;
}

.btn-danger {
  background: rgba(248,113,113,0.1);
  border: 1px solid rgba(248,113,113,0.3);
  color: #f87171;
}

.btn-badge {
  background: rgba(0,0,0,0.15);
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.link-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 12px;
  font-family: inherit;
  cursor: pointer;
  padding: 6px 0;
}

.link-fields {
  margin-top: 10px;
  display: none;
}

.link-fields.open {
  display: block;
}

.settings-hint {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 8px;
  text-align: center;
}

/* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 300;
  padding: 20px;
}

.confirm-overlay.active {
  display: flex;
}

.confirm-box {
  background: var(--surface);
  border-radius: 16px;
  padding: 32px;
  max-width: 340px;
  width: 100%;
  text-align: center;
}

.confirm-icon {
  font-size: 42px;
  margin-bottom: 16px;
}

.confirm-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 10px;
}

.confirm-text {
  font-size: 14px;
  color: var(--text-dim);
  margin-bottom: 24px;
  line-height: 1.5;
}

.confirm-btns {
  display: flex;
  gap: 12px;
}

.confirm-btns button {
  flex: 1;
  padding: 14px;
  font-size: 15px;
  font-family: inherit;
  border-radius: 12px;
  cursor: pointer;
}

.confirm-cancel {
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
}

.confirm-ok {
  background: #dc2626;
  border: none;
  color: white;
  font-weight: 700;
}

.confirm-ok.link {
  background: var(--accent);
  color: var(--bg);
}

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 13px;
  color: var(--text);
  z-index: 250;
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
}

@keyframes toastIn {
  from { opacity: 0; transform: translateX(-50%) translateY(10px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

@keyframes toastOut {
  to { opacity: 0; }
}

/* ç´™å¹é›ª */
.confetti {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 500;
  overflow: hidden;
}

.confetti i {
  position: absolute;
  width: 8px;
  height: 8px;
  animation: fall 3s ease-out forwards;
}

@keyframes fall {
  0% { transform: translateY(-50px) rotate(0); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ— */
.levelup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10,10,15,0.95);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 400;
}

.levelup-overlay.active {
  display: flex;
}

.levelup-content {
  text-align: center;
  animation: popIn 0.5s ease;
}

@keyframes popIn {
  from { opacity: 0; transform: scale(0.8); }
  to { opacity: 1; transform: scale(1); }
}

.levelup-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

.levelup-label {
  font-size: 13px;
  color: var(--accent);
  letter-spacing: 0.15em;
  margin-bottom: 8px;
}

.levelup-value {
  font-size: 42px;
  font-weight: 700;
  color: var(--text);
}

.levelup-sub {
  font-size: 14px;
  color: var(--text-dim);
  margin-top: 4px;
}

.levelup-btn {
  margin-top: 40px;
  padding: 12px 28px;
  font-size: 13px;
  font-family: inherit;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  cursor: pointer;
}

  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <h1>ğŸ“– Reading Log</h1>
      <button class="header-btn" id="settingsBtn">âš™ï¸</button>
    </header>

<div class="content">
  <!-- ãƒ›ãƒ¼ãƒ ã‚¿ãƒ– -->
  <div class="tab active" id="tab-home">
    <section class="progress">
      <div class="ring-wrapper">
        <svg viewBox="0 0 150 150">
          <circle class="ring-bg" cx="75" cy="75" r="66"/>
          <circle class="ring-fill" id="ring" cx="75" cy="75" r="66"/>
        </svg>
        <div class="ring-center">
          <div class="ring-level" id="level">1</div>
          <div class="ring-title" id="title">èª­æ›¸ãƒ“ã‚®ãƒŠãƒ¼</div>
        </div>
      </div>
      <div class="xp-text"><span id="xp">0</span> / 5 XP</div>
    </section>
    
    <button class="main-btn" id="startBtn">èª­æ›¸ã‚’ã¯ã˜ã‚ã‚‹</button>
    
    <div class="quote">
      <p id="quoteText">èª­æ›¸ã¯å¿ƒã®æ—…è·¯ã€‚ä¸€ãƒšãƒ¼ã‚¸ãŒæ–°ã—ã„ä¸–ç•Œã¸ã®æ‰‰ã¨ãªã‚‹ã€‚</p>
      <p id="quoteAuthor">â€” ä»Šæ—¥ã®ä¸€è¨€</p>
    </div>
  </div>
  
  <!-- æœ¬æ£šã‚¿ãƒ– -->
  <div class="tab" id="tab-books">
    <div class="bookshelf">
      <div class="bookshelf-title">ğŸ“š My Library</div>
      <div class="bookshelf-count" id="bookCount">0</div>
      <div class="bookshelf-label">å†Šèª­äº†</div>
      <div class="shelf-container">
        <div class="shelf-board">
          <div class="shelf-visual" id="shelf"></div>
        </div>
      </div>
    </div>
    <div id="bookList"></div>
  </div>
  
  <!-- è¨˜éŒ²ã‚¿ãƒ– -->
  <div class="tab" id="tab-stats">
    <div class="impact-card">
      <div class="impact-value" id="impactBooks">0å†Š</div>
      <div class="impact-label">èª­ç ´ã—ãŸæœ¬</div>
      <div class="streak-badge" id="streakBadge">
        <span class="streak-fire">ğŸ”¥</span>
        <span class="streak-count" id="streakCount">0</span>
        <span class="streak-label">æ—¥é€£ç¶š</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stats-card">
        <div class="stats-card-value" id="totalHours">0</div>
        <div class="stats-card-label">æ™‚é–“</div>
      </div>
      <div class="stats-card">
        <div class="stats-card-value" id="totalSessions">0</div>
        <div class="stats-card-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
      </div>
      <div class="stats-card">
        <div class="stats-card-value" id="daysSince">1</div>
        <div class="stats-card-label">æ—¥ç›®</div>
      </div>
    </div>
    
    <h3 class="section-title">ä»Šé€±ã®èª­æ›¸</h3>
    <div class="week-chart" id="weekChart"></div>

    <h3 class="section-title">æœªæ¥äºˆæ¸¬</h3>
    <div class="prediction-card">
      <div class="prediction-item">
        <span class="prediction-icon">ğŸ“ˆ</span>
        <div class="prediction-content">
          <div class="prediction-value" id="yearlyPrediction">--å†Š</div>
          <div class="prediction-label">ã“ã®ãƒšãƒ¼ã‚¹ã§ä»Šå¹´èª­ã‚ã‚‹æœ¬</div>
        </div>
      </div>
      <div class="prediction-item">
        <span class="prediction-icon">â­</span>
        <div class="prediction-content">
          <div class="prediction-value" id="nextTitle">--</div>
          <div class="prediction-label" id="nextTitleLabel">æ¬¡ã®ç§°å·ã¾ã§</div>
        </div>
      </div>
    </div>

    <h3 class="section-title">ã‚ãªãŸã®ã‚¹ã‚¿ã‚¤ãƒ«</h3>
    <div class="style-card">
      <span class="style-icon">ğŸ¯</span>
      <div>
        <div class="style-value" id="avgFocus">--</div>
        <div class="style-label">å¹³å‡ã®é›†ä¸­æ™‚é–“</div>
      </div>
    </div>
    <div class="style-card">
      <span class="style-icon" id="timeIcon">ğŸŒ™</span>
      <div>
        <div class="style-value" id="timeType">--</div>
        <div class="style-label">ã‚ˆãèª­ã‚€æ™‚é–“å¸¯</div>
      </div>
    </div>
    
    <div class="tip">
      <span>ğŸ’¡</span>
      <span id="tipText">èª­æ›¸ã‚’å§‹ã‚ã¦è¨˜éŒ²ã‚’ä½œã‚ã†</span>
    </div>
  </div>
</div>

<nav class="nav">
  <button class="active" data-tab="home"><span>ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span></button>
  <button data-tab="books"><span>ğŸ“š</span><span>æœ¬æ£š</span></button>
  <button data-tab="stats"><span>ğŸ“Š</span><span>è¨˜éŒ²</span></button>
</nav>

  </div>

  <!-- èª­æ›¸ç”»é¢ -->

  <div class="reading-screen" id="readingScreen">
    <div class="flame">
      <div class="flame-glow"></div>
      <div class="flame-icon">ğŸ”¥</div>
    </div>
    <p class="reading-label">èª­æ›¸ã«é›†ä¸­ã—ã¦ã„ã¾ã™</p>
    <button class="reading-stop" id="stopBtn">èª­æ›¸ã‚’ãŠã‚ã‚‹</button>
  </div>

  <!-- æœ¬è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->

  <div class="modal-overlay" id="addBookModal">
    <div class="modal">
      <div class="modal-bar"></div>
      <div class="modal-header">
        <h2>èª­äº†ã‚’è¨˜éŒ²</h2>
        <button class="modal-close" data-close="addBookModal">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="celebration">
          <div class="celebration-icon">ğŸŠ</div>
          <p class="celebration-text">1å†Šèª­ã¿çµ‚ãˆãŸè‡ªåˆ†ã‚’è¤’ã‚ã‚ˆã†</p>
        </div>
        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" class="form-input" id="bookInput" placeholder="ä¾‹ï¼šäººã‚’å‹•ã‹ã™">
        </div>
        <div class="form-group">
          <button class="link-toggle" id="linkToggle">
            <span id="linkIcon">+</span>
            <span>ãƒªãƒ³ã‚¯ã‚’è¿½åŠ </span>
          </button>
          <div class="link-fields" id="linkFields">
            <input type="url" class="form-input" id="linkInput" placeholder="Amazonã‚„æ›¸è©•ã¸ã®ãƒªãƒ³ã‚¯">
          </div>
        </div>
        <button class="btn btn-primary" id="addBookBtn">
          <span>èª­äº†ï¼</span>
          <span class="btn-badge">+10 XP</span>
        </button>
        <button class="btn btn-secondary" id="addBookNoXpBtn">éå»ã«èª­ã‚“ã æœ¬ã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->

  <div class="modal-overlay" id="editBookModal">
    <div class="modal">
      <div class="modal-bar"></div>
      <div class="modal-header">
        <h2>æœ¬ã‚’ç·¨é›†</h2>
        <button class="modal-close" data-close="editBookModal">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" class="form-input" id="editBookTitle" placeholder="ä¾‹ï¼šäººã‚’å‹•ã‹ã™">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒªãƒ³ã‚¯ï¼ˆä»»æ„ï¼‰</label>
          <input type="url" class="form-input" id="editBookLink" placeholder="Amazonã‚„æ›¸è©•ã¸ã®ãƒªãƒ³ã‚¯">
        </div>
        <button class="btn btn-primary" id="saveEditBtn">ä¿å­˜</button>
        <button class="btn btn-secondary" data-close="editBookModal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->

  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-bar"></div>
      <div class="modal-header">
        <h2>è¨­å®š</h2>
        <button class="modal-close" data-close="settingsModal">Ã—</button>
      </div>
      <div class="modal-body">
        <button class="btn btn-danger" id="resetBtn">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <p class="settings-hint">èª­æ›¸è¨˜éŒ²ãƒ»XPãƒ»ç™»éŒ²ã—ãŸæœ¬ãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™</p>
      </div>
    </div>
  </div>

  <!-- ãƒªã‚»ãƒƒãƒˆç¢ºèª -->

  <div class="confirm-overlay" id="resetConfirm">
    <div class="confirm-box">
      <div class="confirm-icon">âš ï¸</div>
      <div class="confirm-title">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</div>
      <div class="confirm-text">ã™ã¹ã¦ã®è¨˜éŒ²ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</div>
      <div class="confirm-btns">
        <button class="confirm-cancel" data-close="resetConfirm">ã„ã„ãˆ</button>
        <button class="confirm-ok" id="confirmResetBtn">ã¯ã„</button>
      </div>
    </div>
  </div>

  <!-- æœ¬å‰Šé™¤ç¢ºèª -->

  <div class="confirm-overlay" id="deleteConfirm">
    <div class="confirm-box">
      <div class="confirm-icon">ğŸ“•</div>
      <div class="confirm-title" id="deleteBookTitle">ã€Œã€</div>
      <div class="confirm-text">å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="confirm-btns">
        <button class="confirm-cancel" data-close="deleteConfirm">ã„ã„ãˆ</button>
        <button class="confirm-ok" id="confirmDeleteBtn">ã¯ã„</button>
      </div>
    </div>
  </div>

  <!-- ãƒªãƒ³ã‚¯ç¢ºèª -->

  <div class="confirm-overlay" id="linkConfirm">
    <div class="confirm-box">
      <div class="confirm-icon">ğŸ”—</div>
      <div class="confirm-title">å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚’é–‹ã</div>
      <div class="confirm-text" id="linkConfirmUrl"></div>
      <div class="confirm-btns">
        <button class="confirm-cancel" data-close="linkConfirm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="confirm-ok link" id="confirmLinkBtn">é–‹ã</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ— -->

  <div class="levelup-overlay" id="levelupOverlay">
    <div class="levelup-content">
      <div class="levelup-icon">â¬†ï¸</div>
      <div class="levelup-label">LEVEL UP</div>
      <div class="levelup-value" id="newLevel">Lv.2</div>
      <button class="levelup-btn" id="closeLevelup">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ç§°å·ç²å¾— -->

  <div class="levelup-overlay" id="titleOverlay">
    <div class="levelup-content">
      <div class="levelup-icon" id="newTitleIcon">ğŸ“–</div>
      <div class="levelup-label">NEW TITLE</div>
      <div class="levelup-value" id="newTitleName">æœ¬ã®è™«</div>
      <div class="levelup-sub" id="newTitleSub">å°‘ã—ãšã¤ç¿’æ…£ã«</div>
      <button class="levelup-btn" id="closeTitle">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script>
// ========================================
// å®šæ•°
// ========================================
const STORAGE_KEY = 'readingLogV4';
const XP_PER_LEVEL = 5;
const XP_PER_BOOK = 10;
const MIN_SESSION_MINUTES = 10;

const TITLES = [
  { lv: 1, name: 'èª­æ›¸ãƒ“ã‚®ãƒŠãƒ¼', sub: 'èª­æ›¸ã®æ—…ãŒå§‹ã¾ã‚‹', icon: 'ğŸŒ±' },
  { lv: 3, name: 'æœ¬ã®è™«', sub: 'å°‘ã—ãšã¤ç¿’æ…£ã«', icon: 'ğŸ›' },
  { lv: 5, name: 'èª­æ›¸å®¶', sub: 'èª­æ›¸ãŒæ—¥å¸¸ã«ãªã£ãŸ', icon: 'ğŸ“–' },
  { lv: 10, name: 'èª­æ›¸ãƒãƒ‹ã‚¢', sub: 'æœ¬ãªã—ã§ã¯ç”Ÿãã‚‰ã‚Œãªã„', icon: 'ğŸ“š' },
  { lv: 20, name: 'èª­æ›¸ãƒã‚¹ã‚¿ãƒ¼', sub: 'çŸ¥è­˜ã®æ¢æ±‚è€…', icon: 'ğŸ“' },
  { lv: 35, name: 'èª­æ›¸ã®é”äºº', sub: 'æœ¬ã¨å…±ã«ç”Ÿãã‚‹', icon: 'âš”ï¸' },
  { lv: 50, name: 'èª­æ›¸ç‹', sub: 'æ›¸ç‰©ã®ç‹å›½ã®ä¸»', icon: 'ğŸ‘‘' },
  { lv: 75, name: 'èª­æ›¸ã®è³¢è€…', sub: 'ç„¡é™ã®çŸ¥æµ', icon: 'ğŸ§™' },
  { lv: 100, name: 'èª­æ›¸ç¥', sub: 'ç¥ã®é ˜åŸŸã¸', icon: 'âœ¨' }
];

const QUOTES = [
  { text: 'èª­æ›¸ã¯å¿ƒã®æ—…è·¯ã€‚ä¸€ãƒšãƒ¼ã‚¸ãŒæ–°ã—ã„ä¸–ç•Œã¸ã®æ‰‰ã¨ãªã‚‹ã€‚', author: 'ä»Šæ—¥ã®ä¸€è¨€' },
  { text: 'æœ¬ã‚’èª­ã‚€ã“ã¨ã¯ã€ä»–äººã®é ­ã§è€ƒãˆã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚', author: 'ã‚·ãƒ§ãƒ¼ãƒšãƒ³ãƒã‚¦ã‚¢ãƒ¼' },
  { text: 'è‰¯æ›¸ã¯æœ€è‰¯ã®å‹äººã§ã‚ã‚‹ã€‚', author: 'ãƒ—ãƒ­ãƒ´ã‚¡ãƒ¼ãƒ–' },
  { text: 'çŸ¥è­˜ã¸ã®æŠ•è³‡ã¯ã€å¸¸ã«æœ€é«˜ã®åˆ©æ¯ãŒã¤ãã€‚', author: 'ãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³ãƒ»ãƒ•ãƒ©ãƒ³ã‚¯ãƒªãƒ³' },
  { text: 'æœ¬ã¯å¿ƒã®ç³§ã€‚æ¯æ—¥å°‘ã—ãšã¤å‘³ã‚ãŠã†ã€‚', author: 'ä»Šæ—¥ã®ä¸€è¨€' }
];

const BOOK_COLORS = [
  '#c62828', '#1565c0', '#2e7d32', '#6a1b9a', '#e65100',
  '#00695c', '#37474f', '#8d6e63', '#d84315', '#0277bd'
];

// ========================================
// çŠ¶æ…‹
// ========================================
let state = loadState();
let timer = null;
let seconds = 0;
let deletingBookId = null;
let editingBookId = null;

function createInitialState() {
  return {
    total: 0,
    today: 0,
    date: new Date().toDateString(),
    sessions: 0,
    xp: 0,
    lv: 1,
    books: [],
    history: [],
    milestones: []
  };
}

function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      if (parsed.date !== new Date().toDateString()) {
        parsed.today = 0;
        parsed.date = new Date().toDateString();
      }
      return parsed;
    }
  } catch (e) {}
  return createInitialState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// ========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ========================================
function getTitle(level) {
  for (let i = TITLES.length - 1; i >= 0; i--) {
    if (level >= TITLES[i].lv) return TITLES[i];
  }
  return TITLES[0];
}

function formatTime(minutes) {
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return `${h}:${m.toString().padStart(2, '0')}`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function isValidUrl(str) {
  return str && /^https?:\/\//i.test(str);
}

function adjustColor(hex, amount) {
  const num = parseInt(hex.slice(1), 16);
  const r = Math.min(255, Math.max(0, (num >> 16) + amount));
  const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
  const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
  return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
}

function calculateStreak(history) {
  if (!history.length) return 0;

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // æ—¥ä»˜ã”ã¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const readingDays = new Set(
    history.map(h => new Date(h.d).toDateString())
  );

  let streak = 0;
  const checkDate = new Date(today);

  // ä»Šæ—¥èª­ã‚“ã§ã„ãªã„å ´åˆã¯æ˜¨æ—¥ã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆé–‹å§‹
  if (!readingDays.has(today.toDateString())) {
    checkDate.setDate(checkDate.getDate() - 1);
  }

  while (readingDays.has(checkDate.toDateString())) {
    streak++;
    checkDate.setDate(checkDate.getDate() - 1);
  }

  return streak;
}

function calculateYearlyPrediction(books, history) {
  if (!books.length || !history.length) return '--å†Š';

  const now = new Date();
  const firstSession = new Date(history[0].d);
  const daysSinceStart = Math.max(1, Math.ceil((now - firstSession) / 86400000));

  // 1æ—¥ã‚ãŸã‚Šã®èª­äº†ãƒšãƒ¼ã‚¹
  const booksPerDay = books.length / daysSinceStart;

  // ä»Šå¹´ã®æ®‹ã‚Šæ—¥æ•°
  const endOfYear = new Date(now.getFullYear(), 11, 31);
  const daysLeft = Math.ceil((endOfYear - now) / 86400000);

  // ä»Šå¹´èª­ã‚ã‚‹äºˆæ¸¬å†Šæ•°
  const prediction = books.length + Math.round(booksPerDay * daysLeft);

  return prediction + 'å†Š';
}

function getNextTitleInfo(level, xp) {
  const currentTitle = getTitle(level);
  const nextTitle = TITLES.find(t => t.lv > level);

  if (!nextTitle) {
    return { text: 'æœ€é«˜ä½åˆ°é”ï¼', label: 'å…¨ç§°å·ç²å¾—æ¸ˆã¿' };
  }

  const xpNeeded = (nextTitle.lv - 1) * XP_PER_LEVEL - xp;
  const booksNeeded = Math.ceil(xpNeeded / XP_PER_BOOK);

  return {
    text: nextTitle.name,
    label: `ã‚ã¨${booksNeeded}å†Šã§ç²å¾—`
  };
}

// ========================================
// ãƒªãƒ³ã‚¯ç¢ºèª
// ========================================
let pendingLink = null;

function openLink(url, event) {
  if (event) event.preventDefault();
  pendingLink = url;
  document.getElementById('linkConfirmUrl').textContent = url;
  document.getElementById('linkConfirm').classList.add('active');
}

function confirmOpenLink() {
  if (pendingLink) {
    window.open(pendingLink, '_blank');
    pendingLink = null;
  }
  closeModal('linkConfirm');
}

// ========================================
// UIæ›´æ–°
// ========================================
function updateUI() {
  const title = getTitle(state.lv);
  
  document.getElementById('level').textContent = state.lv;
  document.getElementById('title').textContent = title.name;
  
  const xpInLevel = state.xp % XP_PER_LEVEL;
  document.getElementById('xp').textContent = xpInLevel;
  const percent = (xpInLevel / XP_PER_LEVEL) * 100;
  document.getElementById('ring').style.strokeDashoffset = 414.69 - (percent / 100 * 414.69);
  
  const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
  document.getElementById('quoteText').textContent = quote.text;
  document.getElementById('quoteAuthor').textContent = `â€” ${quote.author}`;
  
  saveState();
}

// ========================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ========================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  
  document.getElementById(`tab-${name}`).classList.add('active');
  document.querySelector(`.nav button[data-tab="${name}"]`).classList.add('active');
  
  if (name === 'books') renderBooks();
  if (name === 'stats') renderStats();
}

// ========================================
// ã‚¿ã‚¤ãƒãƒ¼
// ========================================
function startReading() {
  seconds = 0;
  document.getElementById('readingScreen').classList.add('active');
  timer = setInterval(() => seconds++, 1000);
  document.getElementById('startBtn').textContent = 'èª­æ›¸ä¸­...';
}

function stopReading() {
  clearInterval(timer);
  timer = null;
  document.getElementById('readingScreen').classList.remove('active');
  
  const minutes = Math.floor(seconds / 60);
  state.total += minutes;
  state.today += minutes;
  
  if (minutes >= MIN_SESSION_MINUTES) {
    state.sessions++;
    state.history.push({
      d: new Date().toISOString(),
      m: minutes,
      h: new Date().getHours()
    });
    addXP(1 + Math.floor(minutes / 10));
  }
  
  document.getElementById('startBtn').textContent = 'èª­æ›¸ã‚’ã¯ã˜ã‚ã‚‹';
  seconds = 0;
  updateUI();
}

// ========================================
// XPãƒ»ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
// ========================================
function addXP(amount) {
  const oldLevel = state.lv;
  state.xp += amount;
  state.lv = Math.floor(state.xp / XP_PER_LEVEL) + 1;
  
  if (state.lv > oldLevel) {
    document.getElementById('newLevel').textContent = `Lv.${state.lv}`;
    document.getElementById('levelupOverlay').classList.add('active');
    showConfetti();
    
    const oldTitle = getTitle(oldLevel);
    const newTitle = getTitle(state.lv);
    if (newTitle.name !== oldTitle.name) {
      setTimeout(() => {
        document.getElementById('newTitleIcon').textContent = newTitle.icon;
        document.getElementById('newTitleName').textContent = newTitle.name;
        document.getElementById('newTitleSub').textContent = newTitle.sub;
        document.getElementById('titleOverlay').classList.add('active');
      }, 2000);
    }
  }
}

// ========================================
// æœ¬æ£š
// ========================================
function renderBooks() {
  document.getElementById('bookCount').textContent = state.books.length;
  
  const shelf = document.getElementById('shelf');
  const bookList = document.getElementById('bookList');
  
  if (!state.books.length) {
    shelf.innerHTML = '<div class="empty-shelf">ã¾ã æœ¬ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    bookList.innerHTML = '';
    return;
  }

  shelf.innerHTML = state.books.map((book, i) => {
    const color = BOOK_COLORS[i % BOOK_COLORS.length];
    // æœ¬ã®é«˜ã•ã¨å¹…ã‚’ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è±Šã‹ã«
    const height = 50 + ((i * 17) % 25);
    const width = 14 + ((i * 3) % 8);
    // å°‘ã—å‚¾ãã‚’åŠ ãˆã‚‹
    const tilt = ((i * 7) % 5) - 2;
    const hasLink = isValidUrl(book.link);
    const linkBtn = hasLink
      ? `<button class="tooltip-btn" onclick="openLink('${escapeHtml(book.link)}', event)">ãƒªãƒ³ã‚¯ã‚’é–‹ã</button>`
      : '';
    // æœ¬ã”ã¨ã«å°‘ã—ç•°ãªã‚‹è‰²åˆã„ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const darkerColor = adjustColor(color, -20);
    const lighterColor = adjustColor(color, 15);
    return `
      <div class="mini-book" style="
        height:${height}px;
        width:${width}px;
        background: linear-gradient(to right, ${lighterColor} 0%, ${color} 15%, ${color} 85%, ${darkerColor} 100%);
        transform: rotate(${tilt}deg);
      ">
        <div class="book-tooltip">
          <div class="tooltip-title">${escapeHtml(book.title)}</div>
          ${linkBtn}
        </div>
      </div>`;
  }).join('');
  
  bookList.innerHTML = [...state.books].reverse().map(book => {
    const link = isValidUrl(book.link) ? escapeHtml(book.link) : null;
    const titleHtml = link
      ? `<a href="#" onclick="openLink('${link}', event)">${escapeHtml(book.title)}</a>`
      : escapeHtml(book.title);
    const xpBadge = book.xp ? '<span class="book-xp">+10 XP</span>' : '';

    return `
      <div class="book-item">
        <div class="book-icon">ğŸ“•</div>
        <div class="book-info">
          <div class="book-name">${titleHtml}</div>
          <div class="book-date">${new Date(book.id).toLocaleDateString('ja-JP')}${xpBadge}</div>
        </div>
        <div class="book-actions">
          <button onclick="editBook(${book.id})">âœï¸</button>
          <button onclick="deleteBook(${book.id})">Ã—</button>
        </div>
      </div>
    `;
  }).join('');
}

function addBook(withXP) {
  const title = document.getElementById('bookInput').value.trim();
  if (!title) {
    showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  const link = document.getElementById('linkInput').value.trim();
  
  state.books.push({
    id: Date.now(),
    title,
    link: link || null,
    xp: withXP
  });
  
  if (withXP) {
    addXP(XP_PER_BOOK);
    showConfetti();
    showToast('1å†Šèª­ç ´ï¼+10 XP');
  } else {
    showToast('æœ¬ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
  }
  
  renderBooks();
  updateUI();
  closeModal('addBookModal');
  document.getElementById('bookInput').value = '';
  document.getElementById('linkInput').value = '';
}

function editBook(id) {
  const book = state.books.find(b => b.id === id);
  if (!book) return;
  
  editingBookId = id;
  document.getElementById('editBookTitle').value = book.title;
  document.getElementById('editBookLink').value = book.link || '';
  document.getElementById('editBookModal').classList.add('active');
}

function saveEditBook() {
  const title = document.getElementById('editBookTitle').value.trim();
  if (!title) {
    showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  const book = state.books.find(b => b.id === editingBookId);
  if (book) {
    book.title = title;
    book.link = document.getElementById('editBookLink').value.trim() || null;
    saveState();
    renderBooks();
    showToast('ä¿å­˜ã—ã¾ã—ãŸ');
  }
  closeModal('editBookModal');
}

function deleteBook(id) {
  const book = state.books.find(b => b.id === id);
  if (!book) return;
  
  deletingBookId = id;
  document.getElementById('deleteBookTitle').textContent = `ã€Œ${book.title}ã€`;
  document.getElementById('deleteConfirm').classList.add('active');
}

function confirmDeleteBook() {
  const book = state.books.find(b => b.id === deletingBookId);
  if (book?.xp) {
    state.xp = Math.max(0, state.xp - XP_PER_BOOK);
    state.lv = Math.floor(state.xp / XP_PER_LEVEL) + 1;
  }
  state.books = state.books.filter(b => b.id !== deletingBookId);
  
  saveState();
  renderBooks();
  updateUI();
  showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
  closeModal('deleteConfirm');
}

// ========================================
// çµ±è¨ˆ
// ========================================
function renderStats() {
  document.getElementById('impactBooks').textContent = state.books.length + 'å†Š';
  document.getElementById('totalHours').textContent = Math.floor(state.total / 60);
  document.getElementById('totalSessions').textContent = state.sessions;
  
  const days = state.history.length 
    ? Math.max(1, Math.ceil((Date.now() - new Date(state.history[0].d)) / 86400000)) 
    : 1;
  document.getElementById('daysSince').textContent = days;
  
  // é€±é–“ãƒãƒ£ãƒ¼ãƒˆ
  const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  const now = new Date();
  const data = [];
  let max = 30;
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    const minutes = state.history
      .filter(h => h.d.startsWith(dateStr))
      .reduce((sum, h) => sum + h.m, 0);
    max = Math.max(max, minutes);
    data.push({
      label: dayNames[date.getDay()],
      minutes,
      isToday: i === 0
    });
  }
  
  document.getElementById('weekChart').innerHTML = data.map(d => {
    const height = d.minutes ? Math.max(8, Math.round(d.minutes / max * 60)) : 4;
    return `
      <div class="week-bar${d.isToday ? ' today' : ''}">
        <div class="week-bar-fill${d.minutes ? '' : ' empty'}" style="height:${height}px"></div>
        <span>${d.label}</span>
      </div>
    `;
  }).join('');

  // ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—
  const streak = calculateStreak(state.history);
  document.getElementById('streakCount').textContent = streak;
  document.getElementById('streakBadge').style.display = streak > 0 ? 'inline-flex' : 'none';

  // å¹´é–“èª­æ›¸äºˆæ¸¬
  const yearlyPrediction = calculateYearlyPrediction(state.books, state.history);
  document.getElementById('yearlyPrediction').textContent = yearlyPrediction;

  // æ¬¡ã®ç§°å·ã¾ã§
  const nextTitleInfo = getNextTitleInfo(state.lv, state.xp);
  document.getElementById('nextTitle').textContent = nextTitleInfo.text;
  document.getElementById('nextTitleLabel').textContent = nextTitleInfo.label;

  // ã‚¹ã‚¿ã‚¤ãƒ«
  const history = state.history;
  document.getElementById('avgFocus').textContent = history.length 
    ? Math.round(history.reduce((sum, h) => sum + h.m, 0) / history.length) + 'åˆ†' 
    : '--';
  
  if (history.length >= 3) {
    const hours = history.map(h => h.h);
    const counts = [
      hours.filter(h => h >= 5 && h < 12).length,
      hours.filter(h => h >= 12 && h < 18).length,
      hours.filter(h => h >= 18 && h < 22).length,
      hours.filter(h => h >= 22 || h < 5).length
    ];
    const maxIndex = counts.indexOf(Math.max(...counts));
    const types = [['æœå‹', 'ğŸŒ…'], ['æ˜¼å‹', 'â˜€ï¸'], ['å¤œå‹', 'ğŸŒ™'], ['æ·±å¤œå‹', 'ğŸŒƒ']];
    document.getElementById('timeType').textContent = types[maxIndex][0];
    document.getElementById('timeIcon').textContent = types[maxIndex][1];
  }
  
  // ãƒ’ãƒ³ãƒˆ
  const tips = [];
  if (state.books.length > 0 && state.total > 0) {
    tips.push(`å¹³å‡1å†Šã‚ãŸã‚Š${Math.round(state.total / state.books.length)}åˆ†`);
  }
  if (state.total >= 60) tips.push(`åˆè¨ˆ${Math.floor(state.total / 60)}æ™‚é–“èª­æ›¸`);
  if (state.total >= 120) tips.push(`æ˜ ç”»${Math.floor(state.total / 120)}æœ¬åˆ†ã®æ™‚é–“`);
  
  document.getElementById('tipText').textContent = tips.length 
    ? tips[Math.floor(Math.random() * tips.length)] 
    : 'èª­æ›¸ã‚’å§‹ã‚ã¦è¨˜éŒ²ã‚’ä½œã‚ã†';
}

// ========================================
// ãƒ¢ãƒ¼ãƒ€ãƒ«
// ========================================
function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

// ========================================
// ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
// ========================================
function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function showConfetti() {
  const container = document.createElement('div');
  container.className = 'confetti';
  const colors = ['#e8a87c', '#f0c27b', '#7dd3a8', '#6b5b95', '#f87171'];
  
  for (let i = 0; i < 40; i++) {
    const piece = document.createElement('i');
    piece.style.cssText = `
      left: ${Math.random() * 100}%;
      background: ${colors[i % 5]};
      animation-delay: ${Math.random() * 0.4}s;
      animation-duration: ${2 + Math.random()}s;
    `;
    container.appendChild(piece);
  }
  
  document.body.appendChild(container);
  setTimeout(() => container.remove(), 3000);
}

// ========================================
// ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
// ========================================
document.querySelectorAll('.nav button').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

document.getElementById('startBtn').addEventListener('click', () => {
  timer ? stopReading() : startReading();
});

document.getElementById('stopBtn').addEventListener('click', stopReading);

document.getElementById('settingsBtn').addEventListener('click', () => {
  document.getElementById('settingsModal').classList.add('active');
});

document.querySelector('.nav button[data-tab="books"]').addEventListener('click', () => {
  // æœ¬æ£šã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆæ™‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã«+ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ä»£ã‚ã‚Šã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ããƒœã‚¿ãƒ³ã‚’è¿½åŠ 
});

// æœ¬è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« - æœ¬æ£šã‚¿ãƒ–ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã
document.addEventListener('click', (e) => {
  if (e.target.closest('.header-btn.primary') || 
      (e.target.closest('.header') && document.getElementById('tab-books').classList.contains('active'))) {
    // æœ¬æ£šã‚¿ãƒ–ã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ
  }
});

// FABãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆæœ¬æ£šã‚¿ãƒ–ç”¨ï¼‰
const fab = document.createElement('button');
fab.className = 'header-btn primary';
fab.style.cssText = 'position:fixed;bottom:90px;right:20px;width:56px;height:56px;border-radius:50%;font-size:28px;z-index:50;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
fab.textContent = '+';
fab.addEventListener('click', () => {
  document.getElementById('addBookModal').classList.add('active');
});
document.body.appendChild(fab);

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«FABè¡¨ç¤º/éè¡¨ç¤º
const originalSwitchTab = switchTab;
switchTab = function(name) {
  originalSwitchTab(name);
  fab.style.display = name === 'books' ? 'flex' : 'none';
};

document.getElementById('linkToggle').addEventListener('click', () => {
  const fields = document.getElementById('linkFields');
  const isOpen = fields.classList.toggle('open');
  document.getElementById('linkIcon').textContent = isOpen ? 'âˆ’' : '+';
});

document.getElementById('addBookBtn').addEventListener('click', () => addBook(true));
document.getElementById('addBookNoXpBtn').addEventListener('click', () => addBook(false));
document.getElementById('saveEditBtn').addEventListener('click', saveEditBook);

document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('resetConfirm').classList.add('active');
});

document.getElementById('confirmResetBtn').addEventListener('click', () => {
  localStorage.removeItem(STORAGE_KEY);
  state = createInitialState();
  updateUI();
  closeModal('resetConfirm');
  closeModal('settingsModal');
  showToast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
});

document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteBook);
document.getElementById('confirmLinkBtn').addEventListener('click', confirmOpenLink);

document.getElementById('closeLevelup').addEventListener('click', () => {
  document.getElementById('levelupOverlay').classList.remove('active');
});

document.getElementById('closeTitle').addEventListener('click', () => {
  document.getElementById('titleOverlay').classList.remove('active');
});

// é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
document.querySelectorAll('[data-close]').forEach(btn => {
  btn.addEventListener('click', () => closeModal(btn.dataset.close));
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('active');
  });
});

// åˆæœŸåŒ–
updateUI();
</script>

</body>
</html>