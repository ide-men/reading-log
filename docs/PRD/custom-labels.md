# カスタムラベル機能 PRD

## 概要

本にテーマやトピックを示すラベルを自由につけられる機能を追加する。ラベルによるフィルタリング、バッジ表示、統計表示を可能にする。

## 背景・課題

現状の課題:
- 本はステータス（読書中/読了/未読など）でしか分類できない
- テーマやトピック（AI、ビジネス、歴史など）で本を整理できない
- 特定のテーマの本だけを見たいときに探しにくい
- どんなジャンルの本を多く読んでいるか把握できない

## ゴール

- 本にテーマ・トピックを示すラベルを複数つけられる
- ラベルで本をフィルタリングできる
- ラベル別の読書統計を確認できる

---

## 機能仕様

### ラベルの基本仕様

| 項目 | 仕様 |
|------|------|
| 用途 | テーマ・トピックの分類 |
| 1冊あたりの上限 | 5個（目安） |
| 見た目 | テキストのみ（色なし） |
| 管理方法 | 設定で一覧管理 + 本の編集時に新規追加も可 |

### ラベル管理

#### 設定画面での管理
- ラベル一覧の表示
- 新規ラベルの追加
- 既存ラベルの編集（名前変更）
- ラベルの削除（使用中のラベルは警告表示）

#### 本の編集時
- 既存ラベルから選択
- 新規ラベルをその場で作成
- 入力時に既存ラベルを候補表示（オートコンプリート）

---

## 画面構成

### 本のカード（バッジ表示）

```
┌─────────────────────────────┐
│ 📕 本のタイトル              │
│ [AI] [ビジネス]              │  ← ラベルバッジ
└─────────────────────────────┘
```

### 書斎（フィルタリング）

```
📚 書斎
┌─────────┬─────────┬─────────┐
│ ✅ 読了 │ 📚 未読 │ ⏸️ 中断 │  ← ステータスタブ
└─────────┴─────────┴─────────┘
┌─────────────────────────────┐
│ ラベルで絞り込み:            │
│ [すべて▼] [AI] [ビジネス]... │  ← ラベルフィルター
└─────────────────────────────┘
┌─────────────────────────────┐
│ 📕📗📘📙...                  │
└─────────────────────────────┘
```

### 統計画面

```
📊 ラベル別統計
┌─────────────────────────────┐
│ AI          ████████ 8冊    │
│ ビジネス     ██████ 6冊     │
│ 技術書       ████ 4冊       │
│ 小説         ██ 2冊         │
└─────────────────────────────┘
```

### 本の編集モーダル

```
┌─────────────────────────────┐
│ 本を編集                     │
├─────────────────────────────┤
│ タイトル: [____________]     │
│ リンク:   [____________]     │
│                             │
│ ラベル:                      │
│ [AI ×] [ビジネス ×]          │  ← 選択済みラベル
│ [+ ラベルを追加]             │
│                             │
│     [キャンセル] [保存]      │
└─────────────────────────────┘
```

### ラベル追加UI

```
┌─────────────────────────────┐
│ ラベルを追加                 │
├─────────────────────────────┤
│ [検索/新規作成____]          │
│ ┌─────────────────────────┐ │
│ │ ○ AI                    │ │  ← 既存ラベル候補
│ │ ○ ビジネス               │ │
│ │ ○ 技術書                 │ │
│ │ ────────────────────── │ │
│ │ + 「○○」を新規作成      │ │  ← 新規作成オプション
│ └─────────────────────────┘ │
└─────────────────────────────┘
```

### 設定画面（ラベル管理）

```
⚙️ 設定
├─────────────────────────────┤
│ ラベル管理                   │
├─────────────────────────────┤
│ AI           [編集] [削除]  │
│ ビジネス      [編集] [削除]  │
│ 技術書        [編集] [削除]  │
│                             │
│ [+ 新規ラベルを追加]         │
└─────────────────────────────┘
```

---

## データ構造

### ラベルオブジェクト

```javascript
/**
 * @typedef {Object} Label
 * @property {number} id - ユニークID（タイムスタンプ）
 * @property {string} name - ラベル名
 */
```

### ストレージ

```javascript
// 新規ストレージキー
rl_v1_labels: [
  { id: 1704067200000, name: "AI" },
  { id: 1704067200001, name: "ビジネス" },
  { id: 1704067200002, name: "技術書" }
]
```

### 本オブジェクト（更新後）

```javascript
{
  id: number,
  title: string,
  // ... 既存フィールド

  // 新規追加
  labelIds: number[]  // ラベルIDの配列
}
```

### デフォルト値

- 新規本の `labelIds`: `[]`（空配列）
- マイグレーション時: 既存の本には `labelIds: []` を追加

---

## ラベル操作

### ラベル追加
1. 設定画面から新規作成
2. 本の編集時にその場で新規作成

### ラベル編集（名前変更）
1. 設定画面から編集
2. 既に本に割り当てられているラベルも名前が変わる（IDで参照しているため）

### ラベル削除
1. 設定画面から削除
2. 削除前に使用中の本がある場合は警告
3. 削除すると、割り当てられていた本からも自動的に外れる

### 本へのラベル割り当て
1. 本の編集画面から追加/削除
2. 既存ラベルの選択または新規作成

---

## フィルタリング

### 書斎でのフィルタリング
- ステータスタブ（読了/未読/中断）との組み合わせ
- 複数ラベルでの絞り込み（AND/OR は将来検討）
- 「すべて」で全本表示

### フィルタ状態の保持
- ページ遷移してもフィルタ状態を保持
- UIステートに `selectedLabelId` を追加

---

## 統計

### ラベル別統計
- ラベルごとの本の冊数
- 読了本のみ/全本 の切り替え
- 棒グラフまたはリスト形式で表示

---

## マイグレーション

### 既存データへの対応

```javascript
// book-entity.js の createBook 更新
export function createBook(data) {
  return {
    // ... 既存フィールド
    labelIds: data.labelIds ?? []  // 新規追加
  };
}

// マイグレーション関数
function migrateBooks(books) {
  return books.map(book => ({
    ...book,
    labelIds: book.labelIds ?? []
  }));
}
```

---

## 実装の優先順位

### Phase 1: 基本機能
1. ラベルのデータ構造追加
2. 設定画面でのラベル管理（CRUD）
3. 本の編集画面でのラベル割り当て

### Phase 2: 表示・フィルタリング
4. 本のカードにラベルバッジ表示
5. 書斎でのラベルフィルタリング

### Phase 3: 統計
6. ラベル別統計表示

---

## 今後の拡張可能性（スコープ外）

- ラベルへの色付け
- ラベルのグループ化（親子関係）
- 複数ラベルでのAND/OR検索
- ラベルの並び替え（ドラッグ&ドロップ）
- ラベルのインポート/エクスポート
